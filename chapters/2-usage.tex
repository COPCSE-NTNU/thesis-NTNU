\chapter{Using the Document Class}
\label{chap:usage}


\section{The discretisation scheme and assumptions}
The FtL model first proposed by Petis consist of a car ensemble $\{z^l_{i-1/2}\}$ for $i \in \{1,...,N\}$ and $l = \frac{1}{N}$. The propagation of cars is goverened by the system


\begin{equation} \label{FtL_model}
    \frac{d z_{i-1/2}}{dt} = k(z_{i-1/2}) V( y_i), \, \, \forall i \in \{1,...,N\}, 
\end{equation}
where the following has been defined 
\begin{equation}
    y_i := \frac{l}{z_{i+1/2} - z_{i-1/2}} \forall i \in \{1,...,N\}.  
\end{equation}
The assumptions on $v\left(\rho\right) = V\left(\frac{1}{\rho}\right)$ are 
\begin{align} 
    v &\in \C^{0,1}(\R), \, \, v^{-1} \in \C^{0,1}(\R), \label{assump_v_lipschitz} \\
    v &\text{ is monotonically decreasing} \label{assump_v_decrease}\\
    -v' &\leq M \text{ which implies }\rightleftarrow V^{'}\left(y\right) \leq \frac{M}{y^2} \label{assump_v_derivative}\\
    0&\leq v\left(\rho\right) \leq 1 \text{ and } v(0) = 1, v(1) = 0\label{assump_v_image}\\
    v&\geq 1 - \rho^{\sigma - 1} \text{ for some } \sigma > 1 \label{assump_v_lower_bound}. 
\end{align}
\eqref{assump_v_lipschitz} states that $v$ is bi-Lipschitz, and implicitly strengthens \eqref{assump_v_decrease} to strigtly decreasing. \eqref{assump_v_image} includes a no-collision assumption in $v(1) = 0$, which will be shown in \eqref{lemma:boundY}. The classical Lighthill-Whitham-Richards model, 
\begin{equation}
    v(\rho) = 1 - \rho,
\end{equation}
satisfies these assumptions for $\rho \in [0,1]$. As does any strictly increasing continuous piecewise linear $v$, with $v(0) = 1$ and $v(1) = 0$. 
The assumptions on $k$ are 

\begin{align}
    &k \in BV(\R) \cap \C^{(2)}(\R) \cap L^\infty(\R) \text{ and } \frac{1}{k} \in L^\infty\left(\R\right) \label{assump_k1}\\
    &\dkdx \in BV(\R)\cap L^\infty(\R) \cap \C(\R) \label{assump_k2}\\
    &\ddkdxdx \in L^\infty(\R). \label{assump_k3}
\end{align}
The assumptions that $k, \dkdx, \ddkdxdx \in L^\infty$ are natural, since $k$ models the road conditition it will have be bounded. The assumptions on smoothness and the total variation can for example be seen as a conditions on how the traffic authorities warn a slowdown region for the incoming traffic. If $k$ is to model road work, it is reasonable to expect that the traffic authorities will warn incoming traffic in a manner that can be modelled as smooth, as to avoid road congestion and ensure comfortable travel. 

The FtL system is forward-looking in that the movement of each car depends on the data in front of it, and therefore a forward difference scheme is used to approximate the aggregate densities. The approximate traffic density is

\begin{align} \label{disc_rho}
    \rho^l(x,t) &:= \sum_{i = 1}^{N-1} \frac{1}{y_i}\mathbb{1}_{[z_{i - 1/2}(t), z_{i + 1/2}(t)]}(x),
\end{align}

and is the quantity of primary interest. Since the FtL model in question consideres a finite system of ODEs, $N$ is always finite and the spatial support of \eqref{disc_rho} is compact for $t \in (0,\infty)$. An important derived quantity is 

\begin{align} \label{disc_V}
    V^l(x,t) &:= V\left(\frac{1}{\rho^l}\right) = \sum_{i = 1}^{N-1} V(y_i)\mathbb{1}_{[z_{i - 1/2}(t), z_{i + 1/2}(t)]}(x). 
\end{align}
The approximating procedure resembles a semidiscretisation approach, in that our functions are discontinuous in space and loosely speaking differentiable in time. Other useful quantities include 

\begin{align} 
    k^l(x,t) &:= \sum_{i = 1}^{N-1} k(z_{i-1/2}) \mathbb{1}_{[z_{i - 1/2}(t), z_{i + 1/2}(t)]}(x), \label{approx_k}\\
    \left(\dkdx \right)^l(x,t) &:= \sum_{i = 1}^{N-1} D_+(k(z_{i-1/2})) \mathbb{1}_{[z_{i - 1/2}(t), z_{i + 1/2}(t)]}(x) \label{approx_dkdx}, \\
\end{align}
which will serve as mathematical convenience. Their use will amount to the following: Extending \eqref{approx_k} and \eqref{approx_dkdx} to be equal to $k, \dkdx$ outside of $\supp(\rho^l(\cdot,t)(t)$, then 

\begin{align} \label{k_limit}
     k^l(x,t) \rightrightarrows k(x) \text{ and }
     (\dkdx)^l(x,t) \rightrightarrows \dkdx(x) \text{ on } \R \times [0,T]. 
\end{align}
At any point $x \in \supp(\rho^l(\cdot,t)(t)$ and a given $N$, apply the mean value theorem to bound the error in both \eqref{approx_k} and \eqref{approx_dkdx} by $\max\left(\norm{\dkdx}_\infty, \norm{\ddkdxdx}_\infty\right) \max_{i = 1,...,N-1} z_{i+1/2} - z_{i-1/2}.$ By \eqref{Lemma2_1_corollary} in section \ref{section:distance_cars}, this converges to zero uniformly on any finite interval, and \eqref{k_limit} holds. 

\section{Transforming the FtL model} \label{section:phi}
The coordinate map
\begin{numcases}{\Phi(z) = }
     \int_c^z \frac{1}{k(\hat{z})} d\hat{z} \label{Phi1} &\text{ for } z \geq 0,\\
     - \int_z^c \frac{1}{k(\hat{z})} d\hat{z} &\text{ for } z < 0, 
\end{numcases}
is a $\C^3$-diffeomorphism from $\R$ to itself, under \eqref{assump_k1}. It can be thought of as a sirt of geopotential for the road. A diffeomorphism is a bijective smooth map.  
It can be seen as an alternative coordinate system for the road, which stretches the road to account for road-dependent speed function $k$. Indeed, 

\begin{align}
    \frac{d}{dt} \Phi(z_{i-1/2}) = \Phi'(z) \frac{dz_{i-1/2}}{dt} = V(y_i), \label{FtL_transformed1} 
\end{align}
by the (Fundamental theorem of calculus). For $y \leq z$, 
\begin{align}
    \Phi(z) - \Phi(y) = \int_y^z \frac{1}{k(\hat{z})} d\hat{z}
\end{align}
which shows that $\Phi$ is both Lipschitz continuous and coercive, since
\begin{align}
    \frac{1}{\norm{k}_\infty} \left| z - y\right| \leq \left| \Phi(y) - \Phi(z) \right|  \leq  \norm{\frac{1}{k}}_\infty \left| z - y\right| \label{phi_lipschitz}
\end{align}


Since $\Phi$ is strictly increasing, there exists an inverse map $\Psi$, such that
\begin{equation} \label{Psi_def}
	\Psi \circ \Phi = \Phi \circ \Psi = \text{Id}.
\end{equation}
An application of the inverse function theorem shows that $\Psi \in \C^{\left(1\right)}\left(\R\right)$, since $\Phi \in \C^{\left(1\right)}\left(\R\right)$. Furthermore, the inverse function theorem implies that
%overtydelig
\begin{equation}
    \Psi'(\Phi(x)) \Phi^{'}(x) = 1 \,\, \forall x \in \R.
\end{equation}
Inserting from \eqref{Phi1} and using \eqref{Psi_def}, the inverse function satisfies the following first-order non-linear autonomous ODE
\begin{equation} \label{psi_ODE}
	\Psi^{'}(\Phi) = k(\Psi(\Phi)). 
\end{equation}
In general, there is little hope in solving this explicitly. 

 %The goal is to express \eqref{FtL_model} as an autonomuous system of ordinary differential equations in new coordinate variables $\{\Phi_{i-1/2}\}_{i\in \{1,...,N\}}$, derived by transforming $\{z_{i-1/2}\}_{i\in \{1,...,N\}}$ under \eqref{Phi1}. Equation \eqref{FtL_transformed1} is only half-way there, since the $y_i$ expresses a difference in $z_{i-1/2}$-terms%. 
 
 To fully rewrite \eqref{FtL_model} in $\Phi$-coordinates, $y_i$ is to be expressed in terms of $\Phi_{i+1/2}, \Phi_{i-1/2}$. 

\begin{align} \label{y_i_transformed}
    y_i &= \frac{z_{i-1/2} - z_{i+1/2}}{l} 
     = \frac{\Psi(\Phi_{i+1/2}) - \Psi(\Phi_{i-1/2})}{l} \nonumber \\
     &\overset{MVT}{=} \frac{\Psi^{'}(c) \left(\Phi_{i+1/2} -\Phi_{i-1/2}\right)}{l} \overset{IVT}{=} \frac{k\left(\Psi(c)\right) \left(\Phi_{i+1/2} -\Phi_{i-1/2}\right)}{l}, \, \, \forall i \in \{1,...,N\}.
\end{align}
where $c \in (\Phi_{i-1/2},  \Phi_{i+1/2})$. The third equality is an application of the mean value theorem and the final equality follows from \eqref{psi_ODE}. 

Let 
\begin{align} \label{d_k}
	d_k : \R \times \R &\mapsto \R^+_0 \nonumber \\ 
	(x,y)  &\mapsto k\left(\Psi(c(x,y))\right) \left|y - x\right|,
\end{align} 
where $c(x,y)$ is the constant used in the application of the mean-value theorem in \eqref{y_i_transformed}, for the interval $[\min(x,y), \max(x,y)]$.  The map is symmetric in its arguments, non-negative, and zero if and only if $(x,y) \in D=\{{(x,x)|x\in \R}\}$. However, the triangle inequality may fail to hold, as the scaling of the distances may vary with $k\left(\Psi(c(x,y))\right)$. In conclusion, \eqref{d_k} is not necessarily a metric. %it is, show it!

We are ready to formulate the transformed FtL system:

\begin{equation}\label{FtL_transformed2}  
   \frac{d}{dt} \Phi_{i-1/2}  = V\left(\frac{d_k(\Phi_{i-1/2}, \Phi_{i+1/2})}{l}\right) \text{ for } i \in \{1,..,N\},
\end{equation}
%DEF?
where $d_k$ is defined in \eqref{d_k}. 


The intuition is that $\Phi$ differentiably stretches the road in a manner inversely proportional to $\frac{1}{k}$, such the maximal velocity remains invariably 1. 

The cost of reformulation is the non-linear distance function $d_k$, replacing the usual distance. 

The velocity of a car along the stretched road depend on the scaled distance to the car ahead, and the scaling depends on the local behavior of $k(z)$ between the two vehicles. Since the exact form of $\Psi$ is unknown, this can only be approxmiated locally. %%Skrive om?

One important property of $d_k$ can be derived from the inequalities 
\begin{equation} \label{dk_ineq1}
	\frac{1}{\norm{\frac{1}{k}}_\infty} \leq k\left(\Psi(c(x,y))\right) \leq \norm{k}_\infty, 
\end{equation} 
which hold $k(z) > 0$. \eqref{dk_ineq1} implies that 
\begin{align} \label{dk_ineq2}
	\frac{1}{\norm{\frac{1}{k}}_\infty} \left| y - x\right| \leq d_k(x,y)  \leq  \norm{k}_\infty \left| y - x\right|. 
\end{align}

The bounds acquired in \eqref{dk_ineq2} provides a way to compare transformed and non-transformed distances.


\section{The behavior of limiting distancces between vehicles} \label{section:distance_cars}

The transformed system gives an elegant proof of the following lemma. 
\begin{lemma} \label{lemma:boundY}
	If $y_i(0) \leq C$ for some positive constant and $\kappa > \frac{1}{\sigma}$, then 
	\begin{equation}
		\max_{i \in {1,...,N-1}} l^\kappa y_i(t) \downarrow 0\text{ uniformly as } l \downarrow 0 \, \, \text{ on } [0,T] \,\, \forall T \in \R^+. 
	\end{equation}
	Furthermore, 
	\begin{equation}
		y_i(t) \geq 1 \text{ for } t \in \R^+
 	\end{equation}
\end{lemma}



\begin{proof}
	A bound on $y_i(t)$ is aquired by considering the change in the transformed density, defined by \eqref{y_hat}. 
	\begin{align}
		\frac{d\hat{y}_i}{dt} &= \frac{V\left(\frac{d_k(\Phi_{i+1/2}, \Phi_{i+3/2})}{l}\right) - V\left(\frac{d_k(\Phi_{i-1/2}, \Phi_{i+1/2})}{l}\right)}{l} \nonumber \\
		&\leq \frac{1 - V\left(\inf_{x \in \R} \{k(x)\} \hat{y}_i\right)}{l} \leq \frac{\norm{\frac{1}{k}}_\infty^{\sigma - 1}}{l \hat{y}_i^{\sigma - 1}} \label{bound_deriv_y_hat}
	\end{align}
	
	The first inequality holds due to  \eqref{assump_v_decrease} and \eqref{assump_v_image}, using \eqref{psi_lipschitz}. The second inequality is a consequence of \eqref{assump_v_lower_bound}. \eqref{bound_deriv_y_hat} can be rewritten in the form 
	\begin{align}
		\frac{d\left(y_{i}^{\sigma}\right)}{dt} &\leq \frac{\sigma \norm{\frac{1}{k}}^{\sigma - 1}_\infty}{l} \nonumber\\
		\implies \hat{y}_{i} &\leq \sqrt[\sigma]{\hat{y}_i(0)^\sigma + \frac{\sigma \norm{\frac{1}{k}}^{\sigma - 1}_\infty}{l} t }
	\end{align}
	Finally, \eqref{psi_lipschitz} is used to show that 
	\begin{equation}
		y_i \leq \norm{\frac{1}{k}_\infty} \hat{y_i} \leq \norm{\frac{1}{k}_\infty} \norm{k}_\infty y_i \,\, \forall \,\, i \in \{1,...,N-1\},
	\end{equation}
	which gives the bound
	\begin{equation} \label{proof:y_bound1}
		y_{i} &\leq \sqrt[\sigma]{ \left( \norm{\frac{1}{k}}_\infty \norm{k}_\infty y_i(0)\right)^\sigma + \frac{\sigma \norm{\frac{1}{k}}_\infty}{l} t }.
	\end{equation}
	Observe that 
	\begin{equation} \label{proof:bound_lk_y}
		l^\kappa y_{i} &\leq \sqrt[\sigma]{ l^{\sigma\kappa}\left( \norm{\frac{1}{k}}_\infty \norm{k}_\infty y_i(0)\right)^\sigma +\frac{\sigma  l^{\sigma\left(\kappa - \frac{1}{\sigma}\right)} \norm{\frac{1}{k}}_\infty}{l} t }.
	\end{equation}
	Under the stated assumptions, the left-hand side of \eqref{proof:bound_lk_y} converges to zero on bounded intervals $[0,T]$ for $T \in \R^$, which concludes the proof. 	
\end{proof}

\begin{remark}
	The bound \eqref{y_bound} reduces to an inequality for the original model by Petis \eqref{???} in holdens article for $k = 1$. Since the distances $y$ and $\hat{y}}$ are not proportional, but strongly equivalent, we cannot expect to recover $y(0)$ by sending $t \downarrow 0$ in \eqref{y_bound}. 
	Such a bound can be established by considering the system its original coordinates. 
	\begin{align} \label{bound:dydt}
		\frac{dy_i}{dt} &= D_+(k_{i-1/2}V_i)
		= D_+(k_{i-1/2})V_{i+1} + k_{i-1/2}D_+(V_{i})\\
		&= D_+^z(k_{i-1/2})y_i V_{i+1} + k_{i-1/2}D_+(V_{i}) \leq \norm{\dkdx}_\infty y_i + \frac{\norm{k}_\infty}{l y^{\sigma - 1}},
	\end{align}
	The inequality in \eqref{bound:dydt} is established using the same assumptions as in \eqref{bound_deriv_y_hat}. Analogously, we get the following differential inequality 
	\begin{align}
		\frac{l}{\sigma} \frac{d(y_i^\sigma)}{dt} \leq \norm{\dkdx}_\infty l y_i^{\sigma}  + \norm{k}_\infty.
	\end{align}
	Using an integrating factor, the following is established:
	
	\begin{equation} \label{y_bound2}
		ly_i^\sigma(t) \leq \left( l y_i^\sigma(0) + \frac{\norm{k}_\infty}{\norm{\dkdx}_\infty}\right) e^{\sigma \norm{\dkdx}_\infty t} - \frac{\norm{k}_\infty}{\norm{\dkdx}_\infty}.
	\end{equation}
	Although exponential and asymptotically much weaker than \eqref{proof:y_bound1}, it is clear that the right-hand side of \eqref{y_bound} converges to $ly_i^\sigma(0)$ as $t \downarrow 0$, when $l$ is fixed. Both \eqref{proof:y_bound1} and \eqref{y_bound2} can be used to prove \eqref{lemma:boundY}. 
\end{remark}

\begin{corollary} \label{corollary:max_dist_cars}
	The case $\kappa = 1$ in \eqref{lemma:boundY} shows that the maximal distance from any car to its immediate next,
	\begin{equation} \label{corollary}
		\max_{i \in {1,...,N-1}} \left(z_{i+1/2} - z_{i-1/2}\right) \downarrow 0\text{ uniformly as } l \downarrow 0 \, \, \text{ on } [0,T] \,\, \forall T \in \R^+,
	\end{equation}
	Since  $\sigma > 1$, this always holds. 
\end{corollary}



\section{Bounds on the total variation of discrete densities}

In the theory of conservative and consistent numerical schemes, a well known result is the Lax-Wendroff theorem. It states that a conservative and consistent method that if converges an element of $L^1_{loc}$ and if the spatial total variation is uniformly bounded independently of step-size and time, then the limit is a weak solution. Such methods are said to be total variation bounded, or $TVB$. 

From the theory of scalar conservation laws in one dimensions, total variation is a central concept. Weak entropy solutions are known to be total variation diminishing (TVD). Furthermore, the semigroup operator for the solution is lipschitz continuous in time, where the Lipschitz constant involves the flux and the total variation of initial value.

The aim of this section is therefore to prove that FtL scheme is $TVB$, or concretely, that $TV_x(\rho^l)$ and $TV_x(k^l V^l)$ are bounded on finite intervals. The method will be to consider the system of ODEs in the ambient space, consider the local change in total variation and add these contributions up in the end. 

At the current time, an attempt was made to attack $TV_x(\rho^l)$ in the transformed space, but the proof is not quite finished. Intermediary results are summed up in the next section. Instead, a bound for $TV_x(k^l V^l)$ was aquired directly. A bound for $TV_x(\rho^l)$ was aquired through the back-door, by using the established bounds as well as some extra assumptions on $v$. 


\subsection{A bound for T.V.$_x(k^lV^l)$}
First, consider the discontinuous system of ODEs  (TRansversality conditions!)
 %Hva skjer når sign potensielt skifter fortegn?
\begin{align} \label{local_TV_kv_deriv}
    &\frac{d \left| \Delta_+\left(k_{i-1/2}V_{i}\right) \right|}{dt}=
     \sgn_k(i) \Delta_+\left(\dkdx_{i-1/2} \frac{dx_{i-1/2}}{dt} V_{i}\right) \nonumber\\
     &+ \sgn_k(i) k_{i+1/2} \frac{dV}{dy}(y_{i+1}) D_+(k_{i+1/2}V_{i+1}) - k_{i-1/2} \frac{dV}{dy}(y_i) \left|D_+(k_{i-1/2}V_{i})\right| \label{Diff_kV_1}
\end{align}
for $i \in \{1,...,N-1\}$. The terms have been reordered and re-expressed. For convenience, we have defined 
\begin{align}
	\sgn(i) &:= \sgn(V_{i+1} - V_i) = - \sgn(\rho_l^{i+1} - \rho^l_i), \label{sign_i}\\
	\sgn_k(i) &:= \sgn(k_{i+1/2}V_{i+1} - k_{i-1/2}V_i), \\
	\Delta_+(x_i) &:= x_{i+1} - x_{i}. 
\end{align}
The last equality of \eqref{sign_i} comes from the assumption that $V$ is increasing in $y$, and decreasing in $\rho = \frac{1}{y}$.  

Consider the second and third term of the right-hand side of \eqref{Diff_kV_1}. For each equation, pass the second term to the next equation in the system and recieve a  term equals the third term, up to a sign.  Implicitly, a sum is taken over \eqref{Diff_kV_1} and the right-hand side terms are reordered. In the new system of equations, the second and third term can be combined into

%Write out the sums and show what happens

\begin{align} \label{bound_TVkV1}
    (\sgn_k(i)\sgn_k(i-1) - 1) k_{i-1/2} \frac{dV}{dy}(y_i) \vert D_+{k_{i-1/2}V_{i}})\vert \leq 0. 
\end{align}
 
The exceptional cases for this exhange of terms are the equations $i \in \{ 1, N\}$. Equation 1 does not recieve any terms, and equation $N$ wants to pass a term up to an equation which does not exist. The terms involved are
\begin{numcases}{}
    -k_{1/2}\left| D_+\left(k_{1/2}V_{1}\right) \right| &\text{ for } i = 1 \label{excep_term1}\\
    \sgn_k(N) k_{N+1/2} \frac{dV}{dy}(y_N) D_+\left(k_{N-1/2}V_{N}\right) &\text{ for } i = N. \label{excep_term2},
\end{numcases}
both of which are non-positive.  \eqref{excep_term2} is 0, as $y_N = \infty$ and  $V'(y) \leq \frac{M}{y^2}$ by assumption \eqref{assump_v_derivative}. All in all, the global contribution of terms associated with \eqref{bound_TVkV1} to the change of $TV_x(k^l V^l)$ is non-positive. 

Next, we consider the contribution of the road condition function $k$ to the total variation, which corresponds to the first term of \eqref{k}. Insert the model assumption \eqref{FtL_model} $\frac{dx_{i-1/2}}{dt} = k_{i-1/2} V_i$ in the first term of \eqref{local_TV_kv_deriv} and compute
\begin{align} \label{kv_bound3}
    \Delta_+\left(\dkdx_{i-1/2} k_{i-1/2} V_{i}^2\right) &=
    \Delta_+\left(\dkdx_{i-1/2}\right) k_{i+1/2}V_{i+1}^2 \nonumber\\ 
    &+ \Delta_+\left(k_{i-1/2} V_{i}^2\right)\dkdx_{i-1/2} \nonumber\\
    &=\Delta_+\left(\dkdx_{i-1/2}\right) k_{i+1/2}V_{i+1}^2 \nonumber\\ 
    &+\Delta_+\left(k_{i-1/2} V_{i}\right)\dkdx_{i-1/2}(V_{i+1} + V_i) \nonumber\\
    &-\Delta_+\left(k_{i-1/2}\right)\dkdx_{i-1/2} V_{i+1} V_i, \label{kv_bound3}
\end{align}
Can be seen from two applications of \eqref{Diff_kV_1}.  Under assumptions \eqref{assump_v_derivative}, \eqref{assump_k1}, \eqref{assump_k2} and \eqref{assump_k3} and using \eqref{kv_bound3}, a differential inequality for $TV_x(k_l V_l)$ can be established. 

\begin{align}
    %\frac{d \big( \sum_{i=1}^{N-1} \left|\Delta_+\right(k_{i-1/2}V_i\left)\right| \big)}{dt}
    \frac{d }{dt}TV_x\left(k_l V_l\right) &\leq \sum_{i=1}^{N-1} \left( \norm{k}_\infty \left| \Delta_+\left( \dkdx_{i-1/2}\right) \right| +  \norm{\dkdx}_\infty \left| (\Delta_+\left(k_{i-1/2}\right)\right| + 2\norm{\dkdx}_\infty \left| D_+\left(k_{i-1/2} V_{i}\right) \right| \right) \nonumber \\
    &\leq \norm{k}_\infty TV\left(\dkdx\right) +  \norm{\dkdx}_\infty TV\left(k\right) + 2 \norm{\dkdx}_\infty TV_x\left(k_l V_l\right) . \label{kV_diff_ineq}
\end{align}
Let 
\begin{align}
    C_1 &:= \norm{k}_\infty TV(\dkdx) + \norm{\dkdx}_\infty TV\left( k \right)\\
    C_2 &:= 2 \norm{\dkdx}_\infty
\end{align}

then \eqref{kV_diff_ineq} implies that 

\begin{equation} \label{bound_TV_kv}
    \text{TV}_x(k^lV^l)(t) \leq \left( \text{TV}_x(k^lV^l)(0) + \frac{C_1}{C_2}\right) e^{C_2 t} - \frac{C_1}{C_2},
\end{equation}
using standard techniques and the fact that $T.V._x\right(k^l V^l\left)$ is a sum over Lipschitz functions and is Lipschitz. The fact that any Lipschitz function is absolutely continuous implies that the differential inequality holds. 

\subsection{A bound on $TV_x\left(\rho^l\right)$}

Under assumption \eqref{assump_k1}, \eqref{bound_TV_kv} can be used to find an upper bound for TV$_x(\rho^l)$. Recall that $k, \frac{1}{k} \in BV(\R)$ by \eqref{assump_k1} and \eqref{approx_k}. $TV_x(k_l)$ is bounded above by $TV(k) + 2\norm{k}_\infty$, since $k_l$ would amount to an ordered partition of $k$ for $t \in \R_+$ if one ignores the drops to zero at $z_{1/2}(t)$ and $z_{N-1/2}(t)$, where each drop can be at most $\norm{k}_\infty$ each. The same result holds for $\frac{1}{k}$. Finally, let $\vert \cdot  \vert_{Lip}$ denote the Lipschitz seminorm. 


\begin{align}
    \text{TV}_x(\rho_l) &\leq \text{TV}_x(v^{-1} \circ v \circ \rho_l) \overset{\ref{BVprop}}{\leq} \vert v^{-1} \vert_{Lip} \text{TV}_x(v \circ \rho_l) \nonumber\\
    &\leq \vert v^{-1} \vert_{Lip} \text{TV}_x(\frac{1}{k} (k V(y_l)) \nonumber\\ 
    \overset{\eqref{BVprop}}&{\leq} \vert v^{-1} \vert_{Lip} \Big( \norm{\frac{1}{k}}_\infty \text{TV}_x(k_lV_l) + \norm{k}_\infty \norm{V}_\infty \big( TV(\frac{1}{k}) + 2\norm{\frac{1}{k}}_\infty\big)\Big) \label{bound_TV_rho}
\end{align}
This shows that $TV(\rho_l)$ is bounded on an arbitrary interval $[0,T]$, since $TV(k_l V_l)$ is. We have also shown implicitly that $v(\rho_l)$ is of bounded variation.  

\subsection{Discussion on assumptions}

The current assumptions are rather stringent, in the authors view. They exclude velocity functions on the form $v(\rho) = 1 - \rho^{\sigma - 1}$ for $\sigma > 2$, since the derivative is zero in the origin. $v(\rho) = 1 - \rho$, being its own inverse, satisfies both assumptions, as does any strictly decreasing piecewise linear function $v_p$ satisifying $v_p(0) = 1$ and $v_p(1) = 0$. 

An attempt was made to bound $TV(\rho_l)$ directly, without use of \eqref{bound_TV_kv}. The attempt followed in a similar manner to $k_lV_l$, and the primary difficulty was found to be the interplay between the following cases

\begin{numcases}{Cases}
sgn(D_+(V_i^l)) = sgn(D_+(k_{i-1/2}^l V_i^l)), \label{CaseA} 
\\
sgn(D_+(V_i^l)) \neq sgn(D_+(k_{i-1/2}^l V_i^l)) \label{CaseB}
\end{numcases}

Note that $sgn(\rho_{i+1}^l - \rho^l_i) = - sgn(V_{i+1}^l - V_i^l)$, since $v(\rho)$ is decreasing in $\rho$. The following formulations were found to tackle each case:

\begin{numcases}{\frac{d\vert \rho^l_{i+1} - \rho^l_{i} \vert}{dt} = }
sgn(V_{i+1}^l - V_{i}^l) \big(\rho_{i+1}^l D_+^z(k_{i+1/2}^lV_{i+1}^l) - \rho^l_i D_+^z(k_{i-1/2}^l V_i^l)\big) \label{TV_rho_CaseA}
\\
sgn(V_{i+1}^l - V_{i}^l)\Big((\rho^l_{i+1} - \rho^l_i)D_+^z(k_{i-1/2}^lV_i^l) \nonumber\\
\quad + \rho_{i+1}^l \big(D_+^z(k_{i+1/2}^l V_{i+1}^l) - D_+^z(k_{i-1/2}^lV_{i}^l)\big)\Big) \label{TV_rho_CaseB}
\end{numcases}
    
As an example, consider $k = 1$ and notice that we always fall into case \eqref{CaseA}. We look at \eqref{TV_rho_CaseA} and observe that for this combination of case and equation, the second term in the parenthesis will be negative. It corresponds to the natural mechanism programmed into each vehicle, where each car adjusts its' movement in accordance with the next vehicle. By moving the first term in the parenthesis up one index in the system for all $i \in \{2,...,N-1\}$ and taking care of border cases, the result is that the FtL-discretisation is a total variation diminishing approximation to the macroscopic model, or TVD. This is to be desired. Too much, even. The cancellation behavior is convenient, since we essentially have an $l$-term in the denominator in each term of \eqref{TV_rho_CaseA}, which can blow up as $l \downarrow 0$. 

Consider now $\eqref{TV_rho_CaseB}$, found by simple re-ordering of the terms of \eqref{TV_rho_CaseA}, and case \eqref{CaseB}, where $k_{i+1/2} - k_{i-1/2}$ is of opposite sign and has larger absolute value than $V_{i+1} - V_{i}$ (up to some fixed constant). Using the mean-value-theorem, we get that 
\begin{equation}
    \vert k_{i+1/2} - k_{i-1/2} \vert \leq \norm{\dkdx}_\infty \vert z_{i+1/2} - z_{i-1/2}\vert \downarrow 0 \text{ as } l\downarrow0,
\end{equation}
since $\max_{i \in \{1,...,N\}}\lvert z_{i+1/2} - z_{i-1/2} \vert \downarrow 0$ as $l \downarrow 0$ by \eqref{Lemma2_1}. This implies that $\vert V_{i+1} - V_{i}\vert $ can be made arbitrarily small. If we think of $V$ as "approximately constant", the first term of \eqref{TV_rho_CaseB} is set up to provide an exponential bound, while second term will be  the total variation in $\dkdx$. This setup aims at establishing a similar result as \eqref{bound_TV_kv}. 

Given that either case were to always hold, the wanted results could be proven. The issue arises when one case is followed by other, since both formulations each rely on some form of passing-along and cancellation of terms that could blow up as $l\downarrow 0$. The terms passed along will be different depending on the case and choice of re-ordering, and are not immediately compatible. The analysis becomes techincal, and I found that that the need to control certain quantities, e.g.  $\vert \rho_{i+1} - \rho_{i}\vert$ given $\vert v(\rho^l_{i+1}) - v_i(\rho^l_i) \vert$, gave arise to similar assumptions used to establish \eqref{bound_TV_rho}. 

If the direct proof was found, it would also yield a bound on $BV(V_l)$ for free, since $V_l = v \cirv \rho_l$ and $v$ is assumed Lipschitz. By (...), $V_l, k_L V_l \in BV(R)$, without assumptions on the existene of $v^{-1}$. This result is clearly stronger. 

\section{A bound on the total variation using \eqref{FtL_transformed1}}

An advantage with coordinate transformation \label{section:Phi} is that bounds on the variation are easier to establish. 
If 
\begin{align}
	\hat{y}_i := \frac{d_{\frac{1}{k}}(z_{i-1/2}, z_{i+1/2})}{l} = \frac{\Phi_{i+1/2} - \Phi_{i-1/2}}{l} =  \text{ for } i \in \{1,...,N-1\}, 
	\hat{\rho}_i = \frac{1}{y_i}
\end{align}
is the inverse density for the stretched road, then 
 
\begin{equation}
	\sum_{i=1}^{N-1} \left| \hat{\rho}_{i+1}-\hat{\rho}_{i} \right| \leq C t \text{ on } [0,T].
\end{equation} \label{TV_yhat}
where $C$ is independent on $N$. 

Proof: 
Consider the size of the jump 
\begin{align} \label{distance_deriv_trans}
	\frac{d}{dt} \left| \hat{\rho}_{i+1} - \hat{\rho}_{i} \right| = \sgn\left(\hat{y}_{i+1} - \hat{y_{i}}\right) \left(\hat{\rho}_{i+1}^2D_+(V_{i+1}) - \hat{\rho}_{i}^2 D_+(V_i)\right) \text{ for } i \in \{1,..,N-1\}
\end{align}
The intuition of the proof is to use the fact that the right-hand side in \eqref{distance_deriv_trans} is similar to 
\begin{equation} \label{sign_eq1}
	\sgn\left(y_{i+1} - y_{i}\right) \left(\hat{\rho}_{i+1}^2 D_+(V_{i+1}) - \hat{\rho}_{i}^2 D_+(V_i)\right),
\end{equation}
%Think about whether we can replace rho with hatrho above!
%Consider the periodic case
%Consider the case where we dont have the first vehicle travelling at max speed!
and that \eqref{assump_k3} implies 
\begin{equation}\label{sign_eq2}
	\sgn(D_+(V_i)) = \sgn(y_{i+1} - y_i). 
\end{equation}

\eqref{sign_eq2} implies that \eqref{sign_eq1} equals
\begin{equation} \label{sign_eq3}
	\sgn\left(y_{i+1} - y_{i}\right)\hat{\rho}_{i+1}^2 D_+(V_{i+1}) - \left|\hat{\rho}_{i}^2 D_+(V_i)\right|.
\end{equation}
The second term shows how the behavior of the car behind reduces change in the local total variation. All drivers want to obtain the same speed as the driver in-front. In fact, if the car in-front maintains a constant velocity stricly less than one, then the proceding car will converge asymptotically to the same velocity for $k = 1$. This is the mechanism which keeps the total variation from blowing up, and it is therefore necessary to consider the cases

\begin{numcases}{}
	\sgn(\hat{y}_{i+1} - \hat{y}_i) = \sgn(y_{i+1} - y_i), \label{sign_case1}\\
	\sgn(\hat{y}_{i+1} - \hat{y}_i) \neq \sgn(y_{i+1} - y_i).\label{sign_case2} 
\end{numcases}
\eqref{sign_case2} corresponds to the case where the metric $d_k$ significantly stretches the road. In traffic, it describes the case where a car in-front takes off while the car behind enters a slow-down region. This will be most prevalent when few vehicles are considered; when the cars populate the road more densely, both cars will be subject to the same road condition. Using the language of differential geometry, we say that vehicles in arbitrarily small neighbourhoods of $\Phi(\R)$ move on the tangent space of $\R$ under $\Phi$, so that locally the distances are proportional to euclidean distances. In other words, for \eqref{sign_case2} to hold, both $\left|y_{i+1} - y_{i}\right|$ and $\left|\hat{y}_{i+1} - \hat{y}_{i}\right|$ must be very small for the non-linarities in the small neighbourhoods to become prevalent. 
\begin{align}
	y_{i+1} - y_i &= \frac{\inf_{\Phi_{i+1/2}^{\Phi_{i+3/2}} k(\tilde{z}) d \tilde{z} - \inf_{\Phi_{i-1/2}^{\Phi_{i+1/2}} k(\tilde{z}) d \tilde{z}}{l}
\end{align}


the jumps  must be very small In other words, 

Define the set where the stretching is significant

\begin{equation}
	A(t) = \{i \in \{1,...,N-1\} \,\, |\,\, \eqref{sign_case2} \text{ holds}\}
\end{equation}
and partition the sum 

\begin{align}
	\frac{d}{dt}\sum_{i=1}^{N-1} \left| \hat{y}_{i+1}-\hat{y}_{i} \right| &= \sum_{i\in A}  \left2|D_+(V_i)\right| \\
	&+ \sum_{i = 2}^{N-1} \left(\sgn(\hat{y}_{i+1} - \hat{y}_{i})\sgn(\hat{y}_{i} - \hat{y}_{i-1}) - 1 \right)\left|D_+\left(V_i\right)\right| \\
	&- \left|D_+\left(V_1\right)\right|
	+ \sgn(y_{N-1} - y_{N-2})D_+\left(V_{N-1}\right)\right|
\end{align}
Then the sum over 


Two cases are considered. 

\begin{numcases}{Cases}
	sgn(D_+(V_i^l)) = sgn(D_+(k_{i-1/2}^l V_i^l)), \label{CaseA} 
	\\
	sgn(D_+(V_i^l)) \neq sgn(D_+(k_{i-1/2}^l V_i^l)) \label{CaseB}
\end{numcases}

\section{Bound on T.V.($\rho^l$)} \label{section:tv_rho}
We proceed as before to establish a bound on $\rho^l$. Here, the decomposition 

\begin{equation}
\left| x \right| = \max(x,0) + \min(x,0),
\end{equation}
is used. For convenience, define 

\begin{align}
	(x)_+ &:= \max(x,0) \text{ and } (x)_{-} = \min(x,0), \\
	\mathbb{H}^+(i) &:= [\rho_{i+1} - \rho_{i} > 0] \text{ and } \mathbb{H}^-(i) := - [\rho_{i+1} - \rho_{i} < 0] \label{Iverson}
\end{align}
%Definer H som en multifunksjon. 
$[\cdot]$ is the Iverson bracket, which evaluates to 1 if the statement is true and 0 if the statement is false. It is an alternative notation for the Heavyside function. 
Note first that 

\begin{equation} \label{diffrhomax_lipschitz}
	(\rho_{i+1} - \rho_i)_+ \text{ is Lipschitz continuous}.
\end{equation}
This follows from the fact that $(\cdot)_+$ is Lipschitz continuous with constant 1. Since 
\begin{equation}
	\left|\frac{d}{dt} (\rho_{i+1} - \rho_i) \right|= \left| \rho_{i+1}^2D_+(k_{i+1/2}V_{i+1}) - \rho_{i}^2D_+(k_{i-1/2}V_i)\right| \leq \frac{C}{l}, 
\end{equation}
for some $C \in \R$, under assumptions ON V and k. The composition of two Lipschitz continuous functions is also Lipschitz continuous. The composition is therefore Lipschitz continuous and can be differentiated almost everywhere. The claim is now that for $i \in \{1,...,n-2\}$,

\begin{align} \label{deriv_diff_rho1}
	\frac{d}{dt} (\rho_{i+1} - \rho_i)_+ =  -\mathbb{H}(i)\left( \rho_{i+1}^2D_+(k_{i+1/2}V_{i+1}) - \rho_{i}^2D_+(k_{i-1/2}V_i)\right), 
\end{align}
outside of a possibly countable set. This is a consequence of the fact that $\rho_{i+1} - \rho_i$ is differentiable $ \forall i \in \{1,..,n-2\}$, and can attain zero either on connected segments or at isolated points. %hva menes med et isolert punkt, kan disse ha et akkumulasjonspunkt?
On the interior of such connected segments, the derivative of $(\rho_{i+1} - \rho_i)_+$ is zero. Therefore, the choice of version
\begin{equation}
	\frac{d(x)_+}{dx} \overset{a.e.}{=} [x > 0]
\end{equation}
is appropriate for such segments, as the entire right hand side of \eqref{deriv_diff_rho1} will evaluate to zero. 
Let 
\begin{equation}
	U = \cup_{j} O_j, 
\end{equation}
denote the possibly uncountable union over such interiors $O_j$. $U$ is a union of open sets and is therefore open. By exercise 1.6.10 in Terence Tao measure thery be written as a countable union of disjoint open sets with endpoints outside of the union. Therefore, on these endpoints and a possibly countable set of isolated zeros, \eqref{deriv_diff_rho1} may fail to hold. Since ${1,...,n-1}$ is finite, the set is still countable when taken over all $i$. So \eqref{deriv_diff_rho1} holds in the almost everywhere sense. By \eqref{diffrhomax_lipschitz}, it absolutely continuous and the fundamental theorem of calculus holds. With these preliminaries in order, we are ready to state main result of this section. 

\begin{lemma}
	Under \eqref{assump_v_lipschitz}, \eqref{assump_v_decrease}, \eqref{assump_v_image}, \eqref{assump_k1}, \eqref{assump_k2}. For $t \in \R^+$, 
	\begin{equation}
		\text{T.V.}_x(\rho_l)(t) \leq \left(\text{T.V.}_x(\rho_l)(0) + \frac{B_1}{B_2}\right) e^{B_2 t} - \frac{B_1}{B_2}. \label{TV_rho_bound_lemma}
	\end{equation}
	For positive constants $B_1, B_2$. These are given as 
	\begin{align}
		B_1 &= \text{T.V.}\left(\dkdx\right) + 5 \norm{\dkdx}_\infty, \\
		B_2 &= \left(1 + L\right)\norm{\dkdx}_\infty.
	\end{align}
	In other words, the scheme \eqref{disc_rho} is total variation bounded, or T.V.B. 
\end{lemma}

\begin{proof}
	Consider first the change in positive total variation 
	%explain D_+^z transition
	%Do the two for one special, by hiding notation in H(i)
	\begin{align}
		&\frac{d}{dt}\left(\rho_1 + \rho_{N-1} + \sum_{i = 1}^{N-2} (\rho_{i+1} - \rho_i)_+\right) = \label{TV_rho_left-hand_side}\\
		&=\sum_{i = 1}^{N-2} -\mathbb{H}(i)\left(\rho_{i+1}^2 D_+(k_{i+1/2}V_{i+1})) - \rho_{i}^2 D_+(k_{i-1/2}V_{i}) + \right) + \frac{d}{dt}\rho_1 + \frac{d}{dt}\rho_{N-1}\nonumber \\
		&= \sum_{i = 2}^{N-1} -\mathbb{H}(i-1)\rho_{i} D_+^z(k_{i-1/2}V_{i}) + \sum_{i = 1}^{N-2} \mathbb{H}(i)\rho_{i} D_+^z(k_{i-1/2}V_{i}) + \frac{d}{dt}\rho_1 + \frac{d}{dt}\rho_{N-1}, \label{TV_rho_split_sum} 
	\end{align}
	where the second equation is obtained by an index shift and using the fact that 
	\begin{align}
		\rho_i D_+(k_{i-1/2}V_i) = D_+^z(k_{i-1/2}_i).
	\end{align}
	 The indices overlap outside of $i \in \{1,N-1\}}$. These can each be added to with its corresponding term, $\frac{d}{dt}\rho_1$ and $  \frac{d}{dt}\rho_{N-1}$ which combined give the following inequalities. 
	\begin{align}
		-(1+\mathbb{H}(N-2))\rho_{N-1}\left(V_{N-1} D_+^z(k_{N-3/2}) + k_{N-1/2} D_+^z(V_{N-1})\right) &\leq 2 \norm{\dkdx}_\infty \label{TV_rho_bdry_ineq1}\\
		-(1 -\mathbb{H}(1))\rho_{1}\left(V_1 D_+^z(k_{1/2}) + k_{3/2} D_+^z(V_{1})\right) &\leq \norm{\dkdx}_\infty \label{TV_rho_bdry_ineq2}. 
	\end{align}
	Start with \eqref{TV_rho_bdry_ineq1}. It follows from the following constraints
	\begin{align}
		0 &< (1+\mathbb{H}(N-2)) \leq 2 \label{constr1}\\
		0 &\leq  V_{N-1} \leq 1 \text{ by } \eqref{assump_v_image} \label{constr2}\\
		0 &\leq  \rho_{N-1} \leq 1 \text{ by } \eqref{lemma:boundY} \label{constr3}\\ 
		0 &\leq \frac{v_{max} - v(\rho_{N-1})}{z_{N - 1/2} - z_{N-3/2}} = D_+^z(V_{N-1}) \label{diffV_N-1} \label{constr4}\\ 
		\left|D_+^z(k_{N-3/2})\right| &\leq \norm{\dkdx}_\infty \label{constr5}. 
	\end{align} 
	The positivity of \eqref{constr1}, \eqref{constr2}, \eqref{constr3} and \eqref{constr4} imply the combined term is non-positive, due to the negative sign in front. The remaining terms can be bounded by $2\norm{\dkdx}_\infty$. 
	%Use clever ref 
	Similarly, for \eqref{TV_rho_bdry_ineq2}, we have
	\begin{align}
		0 &\leq (1-\mathbb{H}(1)) \leq 1 \label{constr6}\\
		0 &\leq  V_{1} \leq 1 \text{ by } \eqref{assump_v_image} \label{constr7}\\
		0 &\leq  \rho_{1} \leq 1 \text{ by } \eqref{lemma:boundY} \label{constr8}\\ 
		0 &\leq (1-\mathbb{H}(1))D_+^z(V_{1}) \label{constr9}\\ 
		\left|D_+^z(k_{1/2})\right| &\leq \norm{\dkdx}_\infty. \label{constr10} 
	\end{align} 
 	\eqref{constr9} holds for the following reason. If $\mathbb{H}(1) = 1$, then the right hand side is zero. If $\mathbb{H}(1) = 0$, then $\rho_2 - \rho_1 < 0$ and $D_+^z(V_{1}) > 0$, by \eqref{assump_v_decrease}. The remaining terms are bounded by $\norm{\dkdx}_\infty$. The remaining terms of the right hand side of \eqref{TV_rho_split_sum} is
 	\begin{align}
 		\sum_{i = 2}^{N-2} \Delta_+(\mathbb{H}(i-1)) \rho_{i} D_+^z(k_{i-1/2}V_{i}) &= \sum_{i = 2}^{N-2} \Delta_+(\mathbb{H}(i-1)) \rho_{i} \left(V_i D_+^z(k_{i-1/2} + k_{i+1/2}D_+^z(V_{i})\right) \nonumber \\
 		&\leq \sum_{i = 2}^{N-2} \Delta_+(\mathbb{H}(i-1)) \rho_{i} V_i D_+^z(k_{i-1/2}). \label{TV_rho_D_+V_ineq}
 	\end{align}
 	\eqref{TV_rho_D_+V_ineq} follows from the fact that 
 	\begin{equation}
 		\Delta_+(\mathbb{H}(i-1)) = - \sgn(D_+^z(V_{i})), \label{TV_rho_D_+V_ineq_sign}
 	\end{equation}
 	where $\sgn(0) = 0$. \eqref{TV_rho_D_+V_ineq_sign} implies that 
 	\begin{equation}
 		\Delta_+(\mathbb{H}(i-1)) \rho_{i}k_{i+1/2}D_+^z(V_{i}) \leq 0, 
 	\end{equation}
 	which gives \eqref{TV_rho_D_+V_ineq}. An index shift is performed on the right hand side of \eqref{TV_rho_D_+V_ineq}, similarly to \eqref{TV_rho_split_sum}. 
 	
 	\begin{align}
 		\sum_{i = 2}^{N-2} \Delta_+(\mathbb{H}(i-1)) \rho_{i} V_i D_+^z(k_{i-1/2}) &= \sum_{i = 2}^{N-2} \mathbb{H}(i) \Delta_+(\rho_{i} V_i D_+^z(k_{i-1/2})) \\
 		&+ \mathbb{H}(N-2) \rho_{N-2} V_{N-2} D_+^z(k_{N-3/2}) - \mathbb{H}(1) \rho_{1} V_{1} D_+^z(k_{1/2}). \label{TV_rho_split_sum_2}
 	\end{align}
 
 	The first three factors of each boundary term is bounded by one, and both fourth factors are bounded by $\norm{\dkdx}_\infty$. Therefore 
 	\begin{equation}
 		\mathbb{H}(N-2) \rho_{N-2} V_{N-2} D_+^z(k_{N-3/2}) - \mathbb{H}(1) \rho_{1} V_{1} D_+^z(k_{1/2}) \leq 2\norm{\dkdx}_\infty. \label{TV_rho_bdry_ineq3}
 	\end{equation}
 	Proceeding from \eqref{TV_rho_split_sum_2}, we expand the forward difference with respect to each term. This results in two sums. 
 	\begin{align}
 		\sum_{i = 2}^{N-2} \mathbb{H}(i) \Delta_+(\rho_{i} V_i D_+^z(k_{i-1/2}) &=  \sum_{i = 2}^{N-2} \rho_{i+1} V_{i+1} \Delta_+(D_+^z(k_{i-1/2})) \mathbb{H}(i) \label{TV_rho_TV_dkdx_1}\\&+ \sum_{i = 2}^{N-2} D_+^z(k_{i-1/2}) \left(V_i \Delta_+(\rho_i)\mathbb{H}(i) + V_{i+1} \Delta_+(V_i)\mathbb{H}(i)\right)  
 	\end{align}
 	The first sum \eqref{TV_rho_TV_dkdx_1}can be bounded immediately: 
 	\begin{equation}
 		\sum_{i = 2}^{N-2} \rho_{i+1} V_{i+1} \Delta_+(D_+^z(k_{i-1/2})) \mathbb{H}(i) \leq \sum_{i = 2}^{N-2} \left|\Delta_+(D_+^z(k_{i-1/2}))\right| \leq \text{T.V.}(\dkdx). \label{TV_rho_TV(dk)_ineq}
 	\end{equation}
 	%Refer to rho, V < 1. 
 	For the second sum, notice that 
 	\begin{equation}
 		\Delta_+(\rho_i)\mathbb{H}(i) = (\rho_{i+1} - \rho_i)_+ \text{ and } \left|\Delta_+(V_i)\mathbb{H}(i)\right| \leq L (\rho_{i+1} - \rho_i)_+. \label{TV_rho_delta_rho_iverson}
 	\end{equation}
 	$L$ is the Lipschitz constant of $v$, which exists by \eqref{assump_v_lipschitz}. Both equations hold by \eqref{Iverson}. Using \eqref{assump_v_image} to bound $V_{i} \leq 1$, $D_+^z(k_{i-1/2}) \leq \norm{\dkdx}_\infty$ and \eqref{TV_rho_delta_rho_iverson}, the following bound can be established. 
 	\begin{align}
 		\sum_{i = 2}^{N-2} D_+^z(k_{i-1/2}) \left(V_i \Delta_+(\rho_i)\mathbb{H}(i) + V_{i+1} \Delta_+(V_i)\mathbb{H}(i)\right) \leq \norm{\dkdx}_\infty \sum_{i = 2}^{N-2} (1 + L) (\rho_{i+1} - \rho_i)_+ \label{TV_rho_exp_ineq}
 	\end{align}
 	It is time to collect all terms involved in the upper bound of \eqref{TV_rho_left-hand_side}. These are \eqref{TV_rho_bdry_ineq1}, \eqref{TV_rho_bdry_ineq2} and \eqref{TV_rho_bdry_ineq3} for the boundary terms. The two remaining terms are the right-hand sides of \eqref{TV_rho_TV(dk)_ineq} and \eqref{TV_rho_exp_ineq}.  
 	\begin{equation}
 		\text{T.V.}_x^+(\rho^l)} := \rho_1 + \rho_{N-1} + \sum_{i = 1}^{N-2} (\rho_{i+1} - \rho_i)_+\right).
 	\end{equation}
 	The proceeding calculations express that 
 	\begin{equation}
 		\frac{d}{dt}\text{T.V.}_x^+(\rho^l)} \leq 5 \norm{\dkdx}_\infty + \text{T.V.}(\dkdx) + (1+L) \norm{\dkdx}_\infty\text{T.V.}_x^+(\rho^l)}, \label{TV_rho_diff_ineq_exp}
 	\end{equation}
 	holds outside of $\Theta$, by the discussion that lead up to the statement of the theorem. The transition from the right-hand side of \eqref{TV_rho_left-hand_side} to \eqref{TV_rho_diff_ineq_exp} are algebraic manipulations and pointwise bounds, so \eqref{TV_rho_diff_ineq_exp} still holds over $\R \backslash \Theta$. Define 
 	\begin{align}
 		B_1 &:= \text{T.V.}\left(\dkdx\right) + 5 \norm{\dkdx}_\infty, \\
 		B_2 &:= \left(1 + L\right)\norm{\dkdx}_\infty.
 	\end{align}
 	Introduce an integrating factor and differentiate
 	\begin{align}
 		\frac{d}{dt}\left(e^{-B_2 t} \text{T.V.}_x^+(\rho^l)\right) = e^{-B_2 t} \left(\frac{d}{dt}\text{T.V.}_x^+(\rho^l) - B_2 \text{T.V.}_x^+(\rho^l)\right) \leq e^{-B_2 t} B_1, \label{TV_rho_integrating_factor}
 	\end{align}
 	which follows from inserting \eqref{TV_rho_diff_ineq_exp}. To justify plugging in the formula, note first that $e^{-B_2 t}$ is Lipschitz continuous on $\R^+_0$. Since the product of two Lipschitz functions is Lipschitz, $e^{-B_2 t} \text{T.V.}_x^+(\rho^l)$ is indeed Lipschitz. Furthermore, the product rule also holds for the almost everywhere derivative, so
 	%product rule for Lipschitz differentiable functions
 	\eqref{TV_rho_integrating_factor} holds outside of $\Theta$. By the second theorem of calculus for Lipschitz functions in Terence Tao, we can integrate both sides.
 	\begin{align}
 		e^{-B_2 t} \text{T.V.}_x^+(\rho^l)(t) - \text{T.V.}_x^+(\rho^l)(0) \leq \frac{B_1}{B_2}(1 - e^{-B_2 t}).
 	\end{align}
 	Rearranging the terms, we get 
 	\begin{equation}
 		\text{T.V.}^+_x(\rho_l)(t) \leq \left(\text{T.V.}^+_x(\rho_l)(0) + \frac{B_1}{B_2}\right) e^{B_2 t} - \frac{B_1}{B_2}.
 	\end{equation}
 	The calculations for $\text{T.V.}^-_x(\rho_l)(t)$ are similar and included in the appendix. The bound is 
 	\begin{equation}
 		\text{T.V.}^-_x(\rho_l)(t) \leq .....
 	\end{equation}
 	
 	

\end{proof}

Forskjeller: 
	- Jeg gjør beviset uten å bruke en forglatning. Mandig. 
	- Bounden min er annerledes 
	- Jeg bruker ()+
	- Jeg bruker Lemma 2, som sier at rho < 1. 
	- Han bruker taylor-expansjoner, og får en Linf bound på k''. Jeg sier at k'' er i L1. 
	- Han må bruke Gronwall, jeg trenger bare å bruke en integrerende faktor. 
	- 

Likheter: 
	- Summesjongleringen er det mye likt. 


\begin{Remark}
	The use of \eqref{lemma:boundY} was only used to establish the upper bound 
	\begin{equation}
		\rho^l_i \leq 1 \forall i \, \in \, \{1,...,N\} \text{ for } N \in \N,
	\end{equation} 
	which is an easy consequence of the assumption $v(1) = 0$
	
\end{Remark}
 is true that 

are differentiable,  


Since $\rho_i$ are differentiable functions with a bounded derivative, they are also Lipschitz continuous.  Since the difference of two Lipschitz continuous functions are also Lipschitz continuous, and the composition of two Lipschitz continuous functions are Lipschitz continuous, the chain rule must hold almost everywhere (one problem is if the image of the first function attains the value where a)
%show both






\section{Establishing the weak solution} \label{section:weak_sol}

A weak solution of a scalar conservatino law is a function $u \in L_1^{loc}(\R^+_0 \times \R) \cup L^\infty(\R^+_0 \times \R)$. In other words, a regular distribution such that the non-linear map $x \rightarrow x_t + f(x)_x$ is a the zero distribution. In short, it means that is satisfies the following equation:
\begin{equation} \label{space_dep_weak_s}
    \int_{\R_0^+}\int_{\R} \rho \phi_t + k(x) f(u) \phi_x dx dt = 0 \quad \forall \phi \in \C^\infty_0(\R^+_0 \times \R).
\end{equation}

generalisation that uses test functions. Let $\phi \in \C^\infty_0(\R^+_0 \times \R)$, the space of smooth test functions with compact support in  $\R^+_0\times\R$. $\R_0^+$ denotes the positive half-line including the origin. The goal of this section is to establish that the limit of the sequence $\{\rho_l\}_l$ is a weak solution. The way to proceed is to partition the $x$-coordinate using the car-train $\{z_{i-1/2}\}_{i \in \{1,..,N\}}$ and exploit the fact that the jumps of the approximating densities, velocities and so on,  are demarcated by differentiable car paths in space time. This allows for application of continuous of continuous differentiation identities. One example is an application of \eqref{LeibRule} over such a partition: 

\begin{align}
    \frac{d}{dt} \int_{z_{i-1/2}(t)}^{z_{i+1/2}(t)} (\phi(x,t) \rho^l_i(t))  dx &= \int_{z_{i-1/2}(t)}^{z_{i+1/2}(t)} \Big(\rho^l_i(t) \frac{\partial \phi(x,t) }{\partial t} + \phi(x,t) \frac{d \rho^l_i(t) }{dt} \Big) dx \nonumber \\
    + \rho^l_i(t) \phi(z_{i+1/2}(t),t) &\frac{dz_{i+1/2}}{dt} - \rho^l_i(t) \phi(z_{i-1/2}(t), t) \frac{dz_{i-1/2}}{dt} \label{WeakSolLeib} \, \, \, \forall i \in \{1,...,N-1\}
\end{align}
All involving quantities are differentiable, and therefore sufficient regularity is present for \eqref{LeibRule} to hold. Let $\supp \phi \subset [t_1, t_2]$ for $0 \leq t_1 < t_2 < \infty$, and $T > t_2$.  The integral of  \eqref{WeakSolLeib} over $[0,T]$ in time leaves $-\int_{z_{i-1/2}}^{z_{i+1/2}} \phi(x,0) \rho^l_i(0)$ dx on the left-hand side, and is $0$ if $t_1>0$. Add all terms on the left and what results is 
\begin{equation}
    \int_{\R} \phi(x,0) \rho^l(x,0) dx. \label{DiscreteInitCond},
\end{equation}
or the approximate intitial condition. This term will not be manipulated further, and is omitted in the proceeding calculations. 

This is assumed in the following calculations, and the other case is discussed in REF TO SUBSECTION.

First, we investigate the term associated with change in mass,

\begin{align}
\int_0^{\infty} \int_{\mathscr{R}}\rho_l \frac{\partial \phi}{\partial t} dz dt 
%
&= \int_0^{\infty} \sum_{i = 1}^{N-1} \rho^l_i \int_{z_{i-1/2}}^{z_{i+1/2}} \frac{\partial \phi}{\partial t} dz dt \nonumber \\ 
%
\overset{\mathrm{(\ref{WeakSolLeib})}}&{=} - \int_0^{\infty} \sum_{i = 1}^{N-1} \frac{d\rho^l_i}{dt}
\int_{z_{i-1/2}}^{z_{i+1/2}}\phi dz + \rho^l_i D_+\big(\phi_{i-1/2}k_{i-1/2}V_{i}\big) dt  \nonumber \\ 
%
\overset{\mathrm{(\ref{discreteDiffPart})}}&{=}\int_0^{\infty} \sum_{i = 1}^{N-1}  - (\rho^l_i)^2 D^z_+(k_{i-1/2} V_i)\int_{z_{i-1/2}}^{z_{i+1/2}} \phi dz + \Big( - \rho^l_i D_+(\rho^l_i) \phi_{i+1/2} k_{i+1/2} V_{i+1} \nonumber \\ \quad &+ \rho^l_N k^l_{N-1/2} V^l_N  \phi_{N-1/2} - \rho^l_1 k^l_{1/2} V^l_1 \phi_{1/2}\Big)dt  \nonumber \\
%
&=\int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} \rho^l_i D_+^z(k_{i-1/2} V_i
) \phi + \rho^l_i D^z_+(\rho^l_i) \phi_{i+1/2}V_{i+1}k_{i+1/2} dz \nonumber \\ \quad &+ \rho^l_N k^l_{N-1/2} V^l_N  \phi_{N-1/2} - \rho^l_1 k^l_{1/2} V^l_1 \phi_{1/2} dt. \label{weak_1st_int}
\end{align}

In addition to the ideas outlined above, a discrete analogue to differentiation by parts is used in the third equality. 
%%Say something about how this case is analoguous to inhomogeneous case

Next we look at the term associated with the flux. Define $k^l: (x,t) \rightarrow \R$ as a discrete approximation to the road condition, as is done in \eqref{disc_road_cond}. We discretise $k^l$ directly for mathematical convenience, and show that the sequence satisifes this equation when $l \downarrow 0$. The argument is concluded by showing that the difference in the two flux converge in the weak star sense to the same limit, the approximated and the true, become arbitrary close for small $l$, and convergence to one implies convergence in the other, which proves that it is a weak solution indeed. First, the approximated flux term is investigated using the same techniques as for $\eqref{weak_1st_int}$


and consider the approximation to the second term in the integrand \eqref{space_dep_weak_s}. The road condition $k$ is to replaced by $k^l$, and it will be shown the approximate 
\begin{align}
    \rho^l k^l V^l \phi 
\end{align}    

 The application of Leibniz rule is 


where the 
We exclude the remainder terms in 
For the following integral it was more helpful to semi-discretize the $k\rho V(\frac{1}{\rho})$-term, and consider $k(z)$ instead of some discretised version. Recall that $k \in \mathscr{C}^{\infty}(\mathscr{R})$ and that 

% \begin{align} 
%     \int_0^{\infty} \int_{\mathscr{R}} \rho_l k(z) V_l \frac{\partial \phi}{\partial z} dz dt  &= \int_0^{\infty} \sum_{i = 1}^{N-1} \rho^l_i V_l^i \int_{z_{i-1/2}}^{z_{i+1/2}} k(z) \frac{\partial \phi}{\partial z} dz dt \nonumber\\
%     %
%     \overset{\mathrm{(\ref{MeanValDefInt})}}&{=} \int_0^{\infty} \sum_{i = 1}^{N-1} \rho^l_i V_l^i l \Tilde{k}_{i-1/2} \int_{z_{i-1/2}}^{z_{i+1/2}}\frac{\partial \phi}{\partial z} dz dt \nonumber\\ 
%     %
%     &= \int_0^{\infty} \sum_{i = 1}^{N-1} \rho^l_i V_l^i l \Tilde{k}_{i-1/2} \int_{z_{i-1/2}}^{z_{i+1/2}}D_+^z(\phi_{i-1/2}) dz dt \nonumber\\ 
%     %
%     \overset{\mathrm{(\ref{discreteDiffPart})}}&{=} - \int_0^{\infty} \sum_{i = 1}^{N-1} D_+^z(\rho^l_i V_l^i \Tilde{k}_{i-1/2}) \int_{z_{i-1/2}}^{z_{i+1/2}} \phi_{i+1/2}dz dt \nonumber\\
%     %
%     &= - \int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} \big(D_+^z(\rho^l_i)V_l^{i+1}\Tilde{k}_{i+1/2} + \rho^l_i D_+^z(V_i \Tilde{k}_{i-1/2})\big) \phi_{i+1/2} dt \label{weak2ndIntegral}
% \end{align}

\begin{align} 
    \int_0^{\infty} \int_{\mathscr{R}} \rho^l k^l V^l \frac{\partial \phi}{\partial z} dz dt  &= \int_0^{\infty} \sum_{i = 1}^{N-1} \rho^l_i k_{i-1/2}^l V^l_i \int_{z_{i-1/2}}^{z_{i+1/2}} \frac{\partial \phi}{\partial z} dz dt \nonumber\\
    %
    &= \int_0^{\infty} \sum_{i = 1}^{N-1} \rho^l_i k_{i-1/2}^l V^l_i \int_{z_{i-1/2}}^{z_{i+1/2}} D_+^z(\phi_{i-1/2}) dz dt \nonumber\\ 
    %
    \overset{\mathrm{(\ref{discreteDiffPart})}}&{=} \int_0^{\infty} \left(-\sum_{i = 1}^{N-1} D_+^z(\rho^l_i V^l_i k_{i-1/2}) \int_{z_{i-1/2}}^{z_{i+1/2}} \phi_{i+1/2}dz \nonumber\\
    \quad \quad &+ \rho^l_N k^l_{N-1/2} V^l_N  \phi_{N-1/2} - \rho^l_1 k^l_{1/2} V^l_1 \phi_{1/2} \right)dt \nonumber\\
    %
    &= \int_0^{\infty} \left(\sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} \left(D_+^z(\rho^l_i)k^l_{i+1/2} V^l_{i+1}  + \rho^l_i D_+^z( k^l_{i-1/2} V^l_i)\right) \phi_{i+1/2} dz \nonumber \\
    \quad \quad &+ \rho^l_N k^l_{N-1/2} V^l_N  \phi_{N-1/2} - \rho^l_1 k^l_{1/2} V^l_1 \phi_{1/2}\right)dt. \label{weak_2nd_int}
\end{align}

Finally, 

\begin{align}
    \left|\int_{\R_0^+}\int_{\R} \rho^l \phi_t + k^l(x,t) f(\rho^l) \phi_x dx dt \right| &=  \left| \int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} D_+^z(k^l_{i-1/2} V^l_i) (\phi - \phi_{i+1/2}) dzdt \right| \nonumber\\
    &\leq  \max_{i \in \{1,..., N-1\}} \left| ly_i \right| \int_0^\infty \norm{\frac{\partial \phi}{\partial x}(\cdot,t)}_\infty \sum_{i = 1}^{N-1} \left| k^l_{i+1/2}V_{i+1}  - k^l_{i-1/2}V_i\right|(t) dt, \label{weak_sol_int_bound}
\end{align}

%include intermediary step above, not so clear. 

where the bound is found by using $\phi(z,t) - \phi(z_{i-1/2},t) = \frac{d\phi}{dz}(c(z))(z - z_{i-1/2})$, for $c \in (z_{i-1/2}, z)$. This is the mean value theorem.  The derivative is bounded with $\norm{\frac{\partial \phi}{\partial x}(\cdot,t)}_\infty$, defined as the maximal partial derivative in the $x$-direction as a function of $t$. Let this function be bounded by $M > 0$. The integrals leads to a quadratic of $z_{i+1/2} - z_{i-1/2}$, one exponent of which is canceled by the $z$ difference appearing in the denominator of $D_+^z$. The integration domain can be written as a compact interval, since $\supp \phi \subset [t_1,t_2]$. The sum term is $TV_x(k^lV^l)$, where $TV_x(\cdot)$ is the total variation in the $x$-direction. By \eqref{bound_TV_kv}, this is bounded on any finite interval. Let  $C > 0$ be such a bound. All terms accounted for, we have that 

\begin{equation} \label{}
    \left|\int_{\R_0^+}\int_{\R} \rho^l \phi_t + k^l(x,t) f(\rho^l) \phi_x dx dt \right|  \leq (t_2 - t_1) M C \max_{i \in \{1,..., N-1\}} \left| ly_i \right| \rightarrow 0 \text{ as } l\downarrow 0, 
\end{equation}
due to \eqref{Lemma2_1}}. 

What remains to show is that $k(x,t)f(\rho^l) \rightarrow k(x)f(\rho^l)$ in the sense of distributions.  What is needed is to show that $k^l(x,t) \rightarrow k(x)$ in $\norm{\cdot}_\infty$. A small complication arises due to the fact that the discontinuities of $k(x,t)$ change with time. We would like the approximation to be uniform in $t$. One way to do this is to extend $k^l$ outside of its support equal to $k(x)$. Since $k^l$ appears in a product with $f(\rho^l)$, $k^l$ can be freely redefined without changing the approximate weak form CITE. 



This can be established by redefining $k^l(x,t)$ in a way which leaves the preceding arguments unchanged.   One way to do so is the following 

\begin{numcases} {\Tilde{k}^l(x,t) = }
k(x) &\text{ for } x \in (-\infty, z_{i-1/2})\cup [z_{N+1/2}, +\infty)] \\ 
\sum_{i=1}^{N-1} k(z_{i-1/2}) \mathbb{1}_{[z_{i-1/2}, z_{i+1/2})(x) &\text{ for } x \in [z_{1/2}, z_{N+1/2})
\end{numcases}
%PROOF 1
Recall that $\dkdx \in \C(\R) \cup L_\infty(\R)$. On any interval $[0,T]$, we have that 

\begin{equation}
    \left| k(x) - k^l(x,t) \right| \leq \norm{\dkdx}_\infty \max_{i \in \{1,...,N-1\}} \big(z_{i+1/2} - z_{i-1/2}\big) \rightarrow 0 \text{ as } l \downarrow 0,
\end{equation}
due to \eqref{Lemma2_1}. 

%PROOF 2
Recall that $k(x)$ is constant outside of the closed ball $[-R_1, R_1]$, by assupmtion ??? which means that approximation is exact outside of $[-\epsilon_1 - R_1, R_1 + \epsilon_1] + [\epsilon_1, \epsilon_1]$, where $\max_{i \in \{1,..,N-1\} l y_i < \epsilon_1$ for $l \leq \delta_1$ $\forall t \in [0,T]$. The fattening of the sets takes care of the two border cases. $k\vert_{\Bar{B}_{R_1+\epsilon_1}(0)$ is uniformly continuous, being a continuous function defined on a compact metric space. Pick $\delta_2 > 0$ such that $\forall {x} \in B_{R_1 + \epsilon_1}(0), \, \, im_k((B_{\delta_2}(x)) \subset B_{\epsilon}(f(x))$. 
Pick $l$ s.t. $\max_{i \in \{1,...,N-1\}} l y_i < \min(\delta_1, \delta_2) \, \, \forall t \in [0,T]$, then


\begin{numcases} {\left| k(x) - \Tilde{k}^l(x,t) \right| \leq }
0 &\text{ for } x \in \R / B_{R_1 + \epsilon}(0) \\ 
\epsilon &\text{ for } x \in B_{R_1 + \epsilon}(0),
\end{numcases}
for $t \in [0,T]$. 

%Conclusion
Recall that $k^l f(\rho^l) = \Tilde{k}^l f(\rho^l)$ and $f(\rho_l) = \rho_l v(\rho_l) \leq 1$, as $v \leq  1$ by assumption and $\rho_l \leq 1$ by \eqref{Lemma2_1}. Now, let $\supp \phi \subset [0,T]$.  

\begin{align}
     \left|\int_{\R_0^+}\int_{\R} (k^l(x,t) - k(x)) f(\rho^l) \phi_x dx dt \right| \leq \epsilon \mu(\supp \phi) \rightarrow 0 \text{ for } l\downarrow 0, 
\end{align}
While of little practical consequence, the final approximation argument only requires continuity of $k$. 
Thus we have shown that the limit is a weak solution. 

\subsection{Weak entropy solution} \label{section:entropy_solution}
In this section, the fact that the limit is a weak entropy solution in the sense of Lax (riseboro)? will be established. Similar to the time-independent flux, an entropy inequality is introduced. Recall that entropy inequality for the problem at hand must satisfy, for any $c \in \R$:

\begin{equation} \label{entropy_sol}
    \int_{\R_0^+}\int_{\R} \left|\rho - c\right| \phi_t + k(x) \sgn( \rho - c ) \left(\rho v(\rho) - c v(c)\right)  \phi_x  dx dt  \geq \int_{\R_0^+}\int_{\R}\text{sign}(\rho - c) \left\frac{\partial f}{\partial x} \right|_{(x,c)} \phi dx dt,
\end{equation}
$\forall \phi \in \C^\infty_0(\R^+_0 \times \R), \, \, \phi \geq 0$.
where 
\begin{equation}
    F(\rho) = \left| \rho - c \right| \left(\rho v(\rho) - c v(c)\right).
\end{equation}
The approach here follow SHORT PROOF, and adjust the proofs to the space dependent case. In the approach, for a convex function differentiable a.e., a Lagrangian entropy flux is used 
\begin{equation} \label{entropy_flux_lagrange}
    Q(y;c) := \int_{\frac{1}{c}}^y \frac{d\eta}{dy}(y) \frac{dV}{dy}(y) dy, 
\end{equation}
instead of the eulerian flux
\begin{equation} \label{entropy_flux_euler}
    F(\rho; c) := \int_{c}^\rho \frac{d\mu}{d\rho}(\rho) \frac{\partial \left(\rho V(\rho)\right)}{\partial \rho} d\rho, 
\end{equation}
for differentiable convex functions $\rho, \mu$. If we have the coordinate transform$\rho = \frac{1}{y}$ and the relation $\mu(\rho) = \rho \eta\left(\frac{1}{\rho}\right)$, then the two fluxes are related. If $\mu = \left| \cdot - c \right|$, where $c \in \R$, then

\begin{equation}
    F(\rho) = \left| \rho - c \right| \left(\rho v(\rho) - c v(c)\right) = \rho V(\rho) - Q\left(\frac{1}{\rho}\right). 
\end{equation}

The reason why \eqref{entropy_flux_lagrange} is used can be seen from taking a convex differentiable function $\eta$ and composing with $y_i(t)$, the discrete inverse density in the FtL model between cars $z_{i - 1/2}$ and $z_{i + 1/2}$. 

The change of the entropy can be decomposed into a term associated with the derivative in road condition $k$ and the jump in lagrangian entropy flux. 
\begin{align}
    \frac{d\eta}{dt}(y_i) &= \frac{d\eta}{dy}(y_i) D_+(k_{i-1/2} V_i) = \frac{d\eta}{dy}(y_i) \big(  D_+(k_{i-1/2})V_{i}  + k_{i+1/2} D_+( V_i)\big) \nonumber \\
    &\leq \frac{d\eta}{dy}(y_i) D_+(k_{i-1/2})V_i + k_{i+1/2}\frac{1}{l}\int_{y_i}^{y_{i+1}} \frac{d\eta}{dy}(y) \frac{dV}{dy}(y) dy \nonumber\\
    &= \frac{d\eta}{dy}(y_i) D_+(k_{i-1/2})V_i + k_{i+1/2} D_+(Q_i), \label{entropy_sol_eta_ineq1}
\end{align}
where the inequality holds as $\frac{dV}{dy} \geq 0$ and $\frac{d\eta}{dy}$ is an increasing function of $y$. 


%IMPROVE LATEX SKILLZ
As in the discussion above, introduce 
\begin{align}
    \mu(\rho) := \rho \eta (\frac{1}{\rho}), \,\, \mu^l_i := \mu (\rho^l_i), \,\, q^l_i = Q\left(\frac{1}{\rho^l_i}\right)
\end{align}
The fact that $\mu$ is convex can be seen from the second derivative 

\begin{align}
    \frac{d^2 \mu}{d^2\rho} = -\left \frac{1}{\rho^2} \frac{d\eta}{dy}\right|_{\frac{1}{\rho}} + \frac{1}{\rho^2}\frac{d \eta }{dy}(\frac{1}{\rho}) + \frac{1}{\rho^3}\frac{d^2 \eta}{d^2y}(\frac{1}{\rho}) = \left \frac{1}{\rho^3} \frac{d^2\eta}{d^2y}\right|_{\frac{1}{\rho}} \geq 0 \, \, \text{ for } \rho \geq 0. 
\end{align}
%what if rho = 0?

Furthermore,   

\begin{align}
    \frac{d\mu^l_i}{dt} &= - \big(\rho^l_i\big)^2 D_+(k_{i-1/2} V_i)\eta(\frac{1}{\rho}) + \rho^l_i \frac{d\eta^l_i}{dt} \nonumber \\
    &\overset{\eqref{entropy_sol_eta_ineq1}}{\leq} -\rho^l_i D_+^z(k_{i-1/2}V_i) \eta^l_i + \left \frac{d\eta}{dy} \right|_{\frac{1}{\rho^l_i}} D_+^z(k_{i-1/2})V_{i+1} + k_{i-1/2} D_+^z(Q_i). \label{mu_derivative}
\end{align}
The proceding is similar to establishing that the limit is a weak solution. First, consider the term related to the change in density, 

\begin{align}
    \int_0^{\infty} \int_{\mathscr{R}}\mu_l \frac{\partial \phi}{\partial t} dz dt 
    %
    &= \int_0^{\infty} \sum_{i = 1}^{N-1} \mu^l_i \int_{z_{i-1/2}}^{z_{i+1/2}} \frac{\partial \phi}{\partial t} dz dt \nonumber \\ 
    \overset{\mathrm{(\ref{WeakSolLeib}) \& \eqref{discreteDiffPart}}}&{=} - \int_0^{\infty} \sum_{i = 1}^{N-1} \frac{d\mu^l_i}{dt}
    \int_{z_{i-1/2}}^{z_{i+1/2}}\phi dz  - D_+(\mu^l_i) \phi_{i+1/2} k_{i+1/2} V_{i+1} \nonumber ) \nonumber \\
    &-\left(k^l_{N-1/2} V^l_N  \mu^l_N \phi_{N-1/2} -  k^l_{1/2} V^l_1 \mu^l_1 \phi_{1/2}\right) dt \nonumber \\ 
    &\geq \int_0^\infty \sum_{i=1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} \Big( \overbrace{D_+^z(k_{i-1/2}V_i) \rho^l_i \eta^l_i}^\text{(A1)} - \overbrace{\left \frac{d\eta}{dy} \right|_{\frac{1}{\rho^l_i}} D_+^z(k_{i-1/2})V_{i+1}}^\text{(B1)} \nonumber \\ \quad & \underbrace{- k_{i-1/2} D_+^z(q_i)}_\text{(C1)}\Big)\phi - \underbrace{D_+^z(\mu^l_i) V_{i+1} k_{i+1/2} \phi_{i+1/2}}_\text{(D1)} dz  \nonumber \\
    &+ \underbrace{-\left(k^l_{N-1/2} V^l_N  \mu^l_N \phi_{N-1/2} -  k^l_{1/2} V^l_1 \mu^l_1 \phi_{1/2}\right)}_{(E1)}dt. \label{entropy_density_int}
\end{align}

The second equality is the same as for the weak solution. The inequality is an application of \eqref{entropy_sol_eta_ineq1}.
Next, consider the entropy flux integral. As seen in \ref{section:weak_sol}, the terms $\mu^l_N k^l_{N-1/2} V^l_N  \phi_{N-1/2} - \mu^l_1 k^l_{1/2} V^l_1 \phi_{1/2}$ will be cancelled by the same terms in the entropy-flux integral, and are omitted. ???

\begin{align}
    \int_0^{\infty} \int_{\mathscr{R}}  k^l \big(\mu^l V^l  - q^l) \frac{\partial \phi}{\partial z} dz dt  &= \int_0^{\infty} \sum_{i = 1}^{N-1} k_{i-1/2}^l \big( \mu^l_i V^l_i - q^l_i\big) \int_{z_{i-1/2}}^{z_{i+1/2}} \frac{\partial \phi}{\partial z} dz dt \nonumber\\
    %
    &= \int_0^{\infty} \sum_{i = 1}^{N-1} k_{i-1/2}^l \big( \mu^l_i  V^l_i  - q^l_i\big) \int_{z_{i-1/2}}^{z_{i+1/2}} D_+^z(\phi_{i-1/2}) dz dt \nonumber\\ 
    %
    \overset{\mathrm{(\ref{discreteDiffPart})}}&{=}  \int_0^{\infty} -\Big(\sum_{i = 1}^{N-1} D_+^z(\mu^l_i k_{i-1/2} V^l_i ) + D_+^z(k_{i-1/2} q^l_i)\int_{z_{i-1/2}}^{z_{i+1/2}} \phi_{i+1/2}dz \nonumber\\
    \quad \quad &+  \left(k^l_{N-1/2} \left(V^l_N  \mu^l_N - q^l_N\right) \phi_{N-1/2} -  k^l_{1/2} \left(V^l_1 \mu^l_1 - q^l_1\right) \phi_{1/2}\right) dt \nonumber\\
    &= \int_0^\infty \sum_{i=1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} - \Bigg( \overbrace{\mu_i^l D_+^z(k_{i-1/2}V_i)}^\text{(A2)} - \overbrace{q_i^lD_+^z(\kim)}^\text{(B2)} \nonumber \\
    & \underbrace{-\kip D_+^z(q_i)}_\text{(C2)} + \underbrace{\kip V_{i+1} D_+^z(\mu_l^i)}_\text{(D2)}  \Bigg) \phi_{i+1/2} dz \nonumber \\
    \quad \quad &+   \underbrace{\left(k^l_{N-1/2} \left(V^l_N  \mu^l_N - q^l_N\right) \phi_{N-1/2} -  k^l_{1/2} \left(V^l_1 \mu^l_1 - q^l_1\right) \phi_{1/2}\right)}_\text{(E2)}  dt. \label{entropy_flux_int}
\end{align}

Adding \eqref{entropy_density_int} and \eqref{entropy_flux_int} together, the terms corresponding to $A, C$ and $D$ will go to zero by an analoguous argument that lead to \eqref{weak_sol_int_bound}. Sufficient conditions are $\mu^l, q^l, k^l \in L^\infty(\R_0^+ \times \R)$, and that $TV_x(k^lV^l), TV_x(\mu^l), TV_x(q^l) \in L^\infty(\R_0^+)$, where we REFER TO DEF for def of TV_x.

%TAKE THE LIMIT FOR ALMOST ALL $C$

Let $\mu  = \left|\cdot - c \right|$ and note that 

\begin{equation}
    \mu^l V^l  - q^l = \text{sign}(\rho^l - c ) (\rho_l v(\rho_l) - c v(c))
\end{equation}



The $B$ terms are of interest for the entropy solutions. Decompose the $B1$ term of \eqref{entropy_density_int} further into two terms with $ \phi \mapsto \phi_{i+1/2}$ and $\phi \mapsto (\phi - \phi_{i+1/2})$. The latter term can be dealt with under boundedness assumptions on $\frac{d \eta}{dy}$ in the same manner as \eqref{weak_sol_int_bound}. Combining the former term with $(B2)$ gives 
\begin{align}
    &\int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} D_+^z(k^l_{i-1/2})\left( - \left\frac{d\eta}{dy}\right|_{\frac{1}{\rho^l_i}} sgn(\rho_l^i - c) - q^l_i\right) \phi_{i+1/2}dz dt \nonumber \\
    % &= \int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} D_+^z(k_{i-1/2}) sgn(\rho_i - k) \left( k V(y_i) - k (V(y_i) - V\left(\frac{1}{k})\right)dz dt \nonumber \\
    &= \int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}} D_+^z(k^l_{i-1/2})\left(sgn(\rho^l_i -c) k V\left(\frac{1}{k}\right)\right) \phi_{i+1/2}dz dt, \label{discrete_entropy_space_dep_int}
\end{align}
on the right-hand side. This is essentially the right-hand side of \eqref{entropy_sol}.

In the further analysis, $\sgn(\rho^l_i - c)$ is the dangerous term. For example, if the pre-image $\rho^{-1}(\{c\})$ has positive measure. A sequence of functions can in principle converge uniformly to $\rho$ from below, all the while the signs differ by 1. In this example we have defined $\sgn(0) = 0$. The difference of the integrals will therefore differ by $\gamma(\rho^{-1}(\{c\})) \, \forall n \in \N.$ Examining the other terms of \eqref{discrete_entropy_space_dep_int}, a term that prohibits this behavior is $D_+^z(k_{i-1/2})$. Since $\rho$ is a weak solution, it cannot be constant in an open set $O$ of space-time where $\frac{dk}{dz} \neq 0$. This can be seen by choosing a positive test function in a small rectangle contained in $0$, and using that the constant solution is indeed classical in this region. This again would force $\frac{dk}{dz} = 0$, which is a contradiction. We have shown informally that $\rho^{-1}(\{c\})$ cannot contain any open set. While this gives an intuiton of convergence to the right-hand side of \eqref{entropy_sol}, it is not sufficient. $\rho^{-1}(\{c\})$ need not be open, but simply measurable. So there may exist some complicated set such that the above still occurs. Instead, a detour will be made that that closely follows the proof of Theorem 8.21 in HOLDENRISEBORO BOOK, under slightly different assumptions. 

Since $\rho, \rho^l$ can be embedded into $L^1(\Omega)$ with $\Omega = \interior{\supp \phi}$. It is clear that $\rho_l \rightarrow \rho$ in $L^1(\Omega)$. Using theorems we can take a subsequence of $\rho_l$ such that the convergence is pointwise $\amma$- almost everywhere.  Let $\Omega$ be some open set containing $\supp \phi$ and apply Lemma 8.20 gives that possibly outside of a countable set $\Gamma = \{c \in \R \,\vert \,  \gamma\{\rho(x,t) = c\} > 0\}$, 
\begin{equation}
    \text{sign} (\rho^l - c) \rightarrow \text{sign}(\rho - c) \quad \text{ pointwise a.e. in } \Omega.  
\end{equation}
In addition, since $k \in \C^{(2)}(\R)$ and $\phi \in \C^{(1)}(\R)$, 
\begin{equation}
    \right)\sum_{i=0}^{N}D_+^z(k^l_{i-1/2}) (t) \phi(z_{i-1/2}, t)  \mathbb{1}_{[z_{i-1/2}(t), z_{i+1/2}(t))} \rightrightarrows \frac{dk}{dz}(x) \phi, 
\end{equation}
where $\rightrightarrows$ denotes uniform convergence.  For $c \in \R$ \textbackslash $\Gamma$, $\norm{k}_\infty \norm{\phi}_\infty k V\left(\frac{1}{\rho}\right) \mathbb{1}_{\supp \phi}$ can be used as a dominating function for the integrand of  \eqref{discrete_entropy_space_dep_int}. The dominating convergence theorem gives that \eqref{entropy_sol} is satisfied. Now, we follow the approach by HOLDEN, and denote the left- and right-hand side of \eqref{entropy_sol} by $L(c), R(c) : \R \mapsto \R$, respectively. Notice that $L$ is continuous, since 

\begin{align}
    &\left|\rho - c_m\right| \phi_t + k(x) \sgn( \rho - c_m ) \left(\rho v(\rho) - c_m v(c_m)\right)  \phi_x \nonumber \\
    \rightarrow &\left|\rho - c\right| \phi_t + k(x) \sgn( \rho - c ) \left(\rho v(\rho) - c v(c)\right)  \phi_x \text{ p.w. a.e.}
\end{align}
for $c_m \rightarrow c$. In a sense, we are in a similar situation as described in the example above, since we cannot controll the convergence of the $\sgn(\rho - c_m)$ on $\rho^{-1}(\{c\})$. This is now taken care of by $\left(\rho v(\rho) - c_m v(c_m)\right) \rightarrow 0$ as $c_m \rightarrow c$, which is the wanted limit.  
Since integrand is bounded on $L^\infty(\Omega)$, continuity is ensured by the dominating convergence theorem. The fact that $\Gamma$ is countable ensures the existence of two sequences $\underline{c_m}, \overline{c_m} \subset \R$ \textbackslash $\Gamma$, such that $\underline{c_m} \downarrow c$ and $\overline{c_m} \uparrow c$. Let $\Xi = \rho^{-1}(\{c\})$ and partition the integration domain as such

\begin{align}
    \int_{\R^+ \times \R \text{\textbackslash} \Xi} \sgn(\rho - \underline{c_m}) \frac{\partial f}{\partial x} \phi dx dt + \int_{ \Xi}\sgn(\rho - \underline{c_m}) \frac{\partial f}{\partial x} \phi dx dt &\leq L(\underline{c_m}) \, \, \forall m \in \N  \label{entropy_inequality_2} \\
    \Rightarrow \int_{\R^+ \times \R \text{\textbackslash} \Xi} \sgn(\rho - c) \frac{\partial f}{\partial x} \phi dx dt + \int_{ \Xi}\frac{\partial f}{\partial x} \phi dx dt &\leq L(c)\label{entropy_inequality_3}
\end{align}
On $\R^+ \times \R \text{\textbackslash} \Xi$, $\sgn(\rho - \underline{c_m}) \rightarrow \sgn(\rho - c)$. On $\Xi$, as $\underline{c_m} \downarrow c$, $\sgn(\rho - \underline{c_m}) = 1 \, \, \forall m \in \N$. The continuity of all involving quantities ensures that \eqref{entropy_inequality_2} also holds in the limit, which shows \eqref{entropy_inequality_3}. One can go through the same argument as above and interchanging $\underline{c_m}$ with  $\overline{c_m}$, which will incur a sign change on the second term. 
\begin{align}
    \int_{\R^+ \times \R \text{\textbackslash} \Xi} \sgn(\rho - c) \frac{\partial f}{\partial x} \phi dx dt - \int_{ \Xi}\frac{\partial f}{\partial x} \phi dx dt &\leq L(c), \label{entropy_inequality_4}
\end{align}
Adding \eqref{entropy_inequality_3} and \eqref{entropy_inequality_4} and dividing by two, one gets 

\begin{align}
    \int_{\R^+ \times \R \text{\textbackslash} \Xi} \sgn(\rho - c) \frac{\partial f}{\partial x} \phi dx dt &\leq L(c).  \label{entropy_inequality_4}
\end{align}
This is in fact what was to be shown, since $\rho = c$ on $\Xi$ and $\sgn(0) = 0$. 
\begin{equation}
    R(c) \leq L(c) \, \, \forall c \in \R, 
\end{equation}
and $\rho$ is a weak entropy solution. 

dominating convergence theorem yields that the  and the each term involving $c$ is continuous, outside of possibly \sgn(\rho - c).  However, if $c_m \rightarrow c$ then $\rho It is enough to show that the Similar to the discussion above, to sequence $\{x_n\}_{\N} \subset \R$ such that $x_n \rightarrow x \in R$ by the dominating convergence theorem. 



Define the $R(c)$ as the right-hand side of rightThe entropy condition is reduced to 

\begin{align}

\end{align}

\begin{equation}
    
\end{equation}


$ 
The first term converges uniformly to $\frac{dk}{dz}$ on any finite interval. Since the support of $\phi_{i-1/2}$ is compact, we can restrict the time domain to a finite interval.


One way to approach, taken from HYPERBOLIC Conservation laws, is to pass to the limit for $c \in \Gamma$. 
For this, we wil use a part of the proof given in HYPERBOLIC book. 
\begin{align}
    \int_K  \left\text{sign} (\rho^l - c) - \text{sign}(\rho - c)\right| dx dt \leq 2 \gamma( \left\text{sign} (\rho^l - c) \neq \text{sign}(\rho - c)\right|
\end{align}
K is a compact measurable subset of $[0,T]\times \R$. It is therefore sufficient that the signs convergence in measure. 


is the term of interest. Under the assumption that $\rho^l \rightarrow \rho$ almost everywhere with respect to lebesgue measure, Lemma 8.20 from can be used. Due to the dominateing convergence theorem, we obtain that \eqref{discrete_entropy_space_dep_int} converges 

% It is clear that the right hand side is bounded by 

% The issue of indeterminacy in $\Tilde{k}$ is resolved using the smootness of $k$ to bound the deviance from $\Tilde{k}_{i-1/2$ and $k_{i-1/2}$. A second application of the mean-value formula yields that 
% \begin{equation} \label{ktildeDiff}
%     \Tilde{k}_{i-1/2} - k_{i-1/2} = k'(c^2_i) (c_i - z_{i-1/2}), \text{ as } {c^2_i \in (z_{i-1/2}, c_i) \subset (z_{i-1/2}, z_{i+1/2})}.
% \end{equation}

% Define $\Tilde{y_i} := \frac{c_{i-1/2} - z_{i - 1/2}}{l} < y_i$ and $\Tilde{k'} := k'(c_{i-1/2}^2)$. Furthermore, note that 
% \begin{equation}
%     \rho^l_i D_+^z(\Tilde{k}_{i-1/2}V_i) - \rho^l_i D_+^z(k_{i-1/2}V_i) = V_{i+1} \Tilde{k'}_{i+1/2}\Tilde{y}_{i+1} - V_{i}\Tilde{k'}_{i-1/2}\Tilde{y}_{i}. 
% \end{equation}
% Now, subtracting $\big(D_+^z(\rho^l_i)V_l^{i+1}k_{i+1/2} + \rho^l_i D_+^z(V_i k_{i-1/2})\big) \phi_{i+1/2$ from the integrand in \ref{weak2ndIntegral} and take absolute value. 

% \begin{align}
%     &|\int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}}\big(D_+^z(\rho^l_i)V_l^{i+1}\Tilde{k'}_{i+1/2} l \Tilde{y_i} +  \Tilde{k'}_{i+1/2}\Tilde{y}_{i+1} - V_{i}\Tilde{k'}_{i-1/2}\Tilde{y}_{i}\big)\phi_{i+1/2} dt | \\
%     &\leq \int_0^{\infty}  \max_{i \in (1,2,,,N-1)}\big{l y_i\big} |\Tilde{k^'}_{i-1/2}|\sum_{i = 1}^{N-1} | \rho_l^({i+1} - \rho_l^({i})|
% \end{align}

% It is clear that the right hand side is bounded by 

% The issue of indeterminacy in $\Tilde{k}$ is resolved using the smootness of $k$ to bound the deviance from $\Tilde{k}_{i-1/2$ and $k_{i-1/2}$. A second application of the mean-value formula yields that 
% \begin{equation} \label{ktildeDiff}
%     \Tilde{k}_{i-1/2} - k_{i-1/2} = k'(c^2_i) (c_i - z_{i-1/2}), \text{ as } {c^2_i \in (z_{i-1/2}, c_i) \subset (z_{i-1/2}, z_{i+1/2})}.
% \end{equation}

% Define $\Tilde{y_i} := \frac{c_{i-1/2} - z_{i - 1/2}}{l} < y_i$ and $\Tilde{k'} := k'(c_{i-1/2}^2)$. Furthermore, note that 
% \begin{equation}
%     \rho^l_i D_+^z(\Tilde{k}_{i-1/2}V_i) - \rho^l_i D_+^z(k_{i-1/2}V_i) = V_{i+1} \Tilde{k'}_{i+1/2}\Tilde{y}_{i+1} - V_{i}\Tilde{k'}_{i-1/2}\Tilde{y}_{i}. 
% \end{equation}
% Now, subtracting $\big(D_+^z(\rho^l_i)V_l^{i+1}k_{i+1/2} + \rho^l_i D_+^z(V_i k_{i-1/2})\big) \phi_{i+1/2$ from the integrand in \ref{weak2ndIntegral} and take absolute value. 

% \begin{align}
%     &|\int_0^{\infty} \sum_{i = 1}^{N-1} \int_{z_{i-1/2}}^{z_{i+1/2}}\big(D_+^z(\rho^l_i)V_l^{i+1}\Tilde{k'}_{i+1/2} l \Tilde{y_i} +  \Tilde{k'}_{i+1/2}\Tilde{y}_{i+1} - V_{i}\Tilde{k'}_{i-1/2}\Tilde{y}_{i}\big)\phi_{i+1/2} dt | \\
%     &\leq \int_0^{\infty}  \max_{i \in (1,2,,,N-1)}\big{l y_i\big} |\Tilde{k^'}_{i-1/2}|\sum_{i = 1}^{N-1} | \rho_l^({i+1} - \rho_l^({i})|
% \end{align}


\section{Thesis Setup and Language Selection}
\label{sec:setup}

The document class is initialized by issuing the \texttt{\textbackslash documentclass[]\{ntnuthesis\}} at the beginning of your \texttt{.tex} file. The thesis language should be given as an option. Currently British English (class option \texttt{[british]}), American English (class option \texttt{[american]}), Norwegian Bokmål (class option \texttt{[norsk]}) and Norwegian Nynorsk (class option \texttt{[nynorsk]}) are supported.\footnote{Disclaimer: this unfortunate naming of the Norwegian language options follows from the naming conventions of the \texttt{babel} package.}

There is also the \texttt{titlepage} class option that triggers the generation of a simple title page that can be used as a placeholder when writing the thesis. This option should be removed before handing in the thesis. Instead the official NTNU titlepage for the corresponding thesis type should be added as described on Innsida.\footnote{see \url{https://innsida.ntnu.no/wiki/-/wiki/English/Finalizing+the+bachelor+and+master+thesis} for bachelor and master, and \url{https://innsida.ntnu.no/wiki/-/wiki/English/Printing+your+thesis} for PhD.}

\section{Title, Author, and Date}

In the preample of the \texttt{.tex} file, the thesis title should be set with the \texttt{\textbackslash title\{\}} command. The title will appear on the titlepage as well as in the running header of the even numbered pages. If the title is too long for the header, you can use \texttt{\textbackslash shorttitle\{\}} to set a version for the header.

The authors should be listed with full names in the \texttt{\textbackslash author\{\}} command. If there are several authors, they should be separated with \texttt{\textbackslash and}, e.g., like this: \texttt{\textbackslash author\{Anne Andersen \textbackslash and Bjørn Bjørnsen\}}. For the running headers, you may want to use \texttt{\textbackslash shortauthor}, e.g. like this: \texttt{\textbackslash shortauthor\{A. Andersen and B. Bjørnsen\}} or even \texttt{\textbackslash shortauthor\{Andersen et al.\}}.

Use \texttt{\textbackslash date\{\}} to set the date of the document. It will only  appear on the temporary title page. To keep track of temporary versions, it can be a good idea to use \texttt{\textbackslash date\{\textbackslash today\}} while working on the thesis. You may also add copyright and licence information in this field.

\section{Page Layout}

The document class is designed to work with twosided printing. This means that all chapters start on odd (right hand) pages, and that blank pages are inserted where needed to make sure this happens. However, since the theses are very often read on displays, the margins are kept the same on even and odd pages in order to avoid that the page is jumping back and forth upon reading.

To avoid blank pages when rendering the thesis, you can enable the \texttt{oneside} option in the \texttt{thesis.tex} file. Just add 'oneside' to the document class options on the first line, and recompile.

\section{Structuring Elements}

The standard \LaTeX{} elements for document structure are supported: chapter, section, and:

\subsection{This is a \texttt{\textbackslash subsection\{\}}}

Short subsection text here.

\subsubsection{This is a \texttt{\textbackslash subsubsection\{\}}}

Short subsubsection text here.

\paragraph{This is a \texttt{\textbackslash paragraph\{\}}}

Short paragraph text here.

Chapters, sections, and subsections will be included in the table of contents, whereas the lower level structuring elements will not appear there. Don't use too many levels of headings; how many are appropriate, will depend on the size of the document. Also, don't use headings too frequently.

Make sure that the chapter and section headings are correctly capitalised depending on the language of the thesis, e.g., `\emph{Correct Capitalisation of Titles in English}' vs. `\emph{Korrekt staving av titler på norsk}'.

Simple paragraphs are the lowest structuring elements and should be used the most. They are made by leaving one (or more) blank line(s) in the \texttt{.tex} file. In the typeset document they will appear indented and with no vertical space between them.

\section{Lists}

Numbered and unnumbered lists, i.e., the \texttt{enumerate} and \texttt{itemize} environments, are used just as in regular \LaTeX{}, but are typeset somewhat more densely and with other labels. Unnumbered list:
\begin{itemize}
    \item first item
    \item second item
    \begin{itemize}
        \item first subitem
        \item second subitem
        \begin{itemize}
            \item first subsubitem
            \item second subsubitem
        \end{itemize}
    \end{itemize}
    \item last item
\end{itemize}
Numbered list:
\begin{enumerate}
    \item first item
    \item second item
    \begin{enumerate}
        \item first subitem
        \item second subitem
        \begin{enumerate}
            \item first subsubitem
            \item second subsubitem
        \end{enumerate}
    \end{enumerate}
    \item last item
\end{enumerate}

For description lists, see usage in, e.g., \cref{sec:frontmatter}.

\section{Figures}

Figures are placed in the \texttt{figure} environment. An example is shown in \cref{fig:mapNTNU}. Figures are floats, hence they will float freely around in the document in accordance with standard \LaTeX{} behaviour. You may want to try to override \LaTeX{}'s default placement by using the \texttt{h} (here), \texttt{t} (top of page), \texttt{b} (bottom of page), and \texttt{p} (separate page) options in order of priority. If you provide an alternate (typically shorter) caption in square brackets, it will be used in the list of figures. Use \texttt{\textbackslash includegraphics[]\{\}} with options \texttt{scale} or \texttt{width} to include the graphics file. The caption should be placed \emph{below} the figure. If the caption consists of a single sentence fragment (incomplete sentence), it should not be punctuated. Given the shape and size of the figure, the figure caption can appear too close or too far from the figure. To deal with this, vertical space, either positive or negative, can be added before and/or after the caption command using the \texttt{\textbackslash vspace{}} command.

\begin{figure}[htbp]  % order of priority: h here, t top, b bottom, p page
  \centering
  \includegraphics[width=.5\textwidth]{figures/kart_student}
  \caption[Map of NTNU Campuses]{The map shows the three main campuses of NTNU.}
  \label{fig:mapNTNU}
\end{figure}

For figures compsed of several sub-figures, the \texttt{caption} and \texttt{subcaption} packages have been preloaded. See \cref{fig:subfig} with \cref{sfig:a,sfig:b} for an example. For more details on alignment etc., see the Overleaf documentation.\footnote{\url{https://www.overleaf.com/learn/latex/How_to_Write_a_Thesis_in_LaTeX_(Part_3):_Figures,_Subfigures_and_Tables}}

\begin{figure}
    \centering
    \begin{subfigure}[b]{.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{figures/kart_student.png}
        \caption{First sub-figure}
        \label{sfig:a}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{figures/kart_student.png}
        \caption{Second sub-figure}
        \label{sfig:b}
    \end{subfigure}
    \caption{A figure composed of two sub-figures. It has a long caption in order to demonstrate how that is typeset.}
    \label{fig:subfig}
\end{figure}

You can make nice graphs directly from data files using \texttt{gnuplot}, for an example, see \cref{fig:examplegnuplot}.

\begin{figure}[htbp]
  \centering
    \begin{gnuplot}[terminal=epslatex,terminaloptions={size 8cm,6cm color}]
        set xlabel "age"
        set ylabel "IQ"
        set key autotitle columnhead
        set title "age vs IQ"
        set yrange [0:160]
        set datafile separator ","
        plot "csvtables/ageiq.csv" using 1:2 with boxes
    \end{gnuplot}
  \caption[An example of Integrated Graph]{This is a gnuplot graph read from a file. Also this figure has a long caption in order to demonstrate how that is typeset.}
  \label{fig:examplegnuplot}
\end{figure}

\section{Tables}

Tables are placed in the \texttt{table} environment. An example is given in \cref{tab:example1}. Like figures, tables float freely around in the document in accordance with standard \LaTeX{} behaviour. The table caption should be placed \emph{above} the table. If the caption consists of a single sentence fragment (incomplete sentence), it should not be punctuated.

\begin{table}
  \centering
  \caption{A simple, manually formatted example table}
  \label{tab:example1}
  \begin{tabular}{cc}
    \hline
    age  & IQ \\
    \hline
    10   & 110 \\
    20   & 120 \\
    30   & 145 \\
    40   & 120 \\
    50   & 100 \\
    \hline
  \end{tabular}
\end{table}

Tables can also be automatically generated from CSV files using the \texttt{simplecsv} and \texttt{booktab} packages. See \cref{tab:examplecsv} for an example.

\begin{table}[tbp]
  \centering
  \caption[A simple example table generated from a CSV file]{A simple example table generated from a CSV file using \texttt{simplecsv} and \texttt{booktab}}
  \label{tab:examplecsv}
  \csvautobooktabular{csvtables/ageiq.csv}
\end{table}

\section{Listings}

Code listings are included by means of the \texttt{listings} package. Code examples can be read from file or provided inline, and should be given a caption for cross referencing and for appearance in the list of code listings in the thesis frontmatter. If all your code examples are written in the same programming language, you can use, e.g., \texttt{\textbackslash lstset\{language=Python\}} to set the language once and for all. The code is set with the monospace font, and the font size is reduced to allow for code lines up to at least 80 characters without causing line breaks. Options for programming languages, line numbering etc. are provided. Unlike figures and tables, code listings are not floating objects, and will appear at the same position in the typeset document as in the \texttt{.tex} file. If the caption consists of a single sentence fragment (incomplete sentence), it should not be punctuated.

\lstinputlisting[
    caption={Python example from file},
    label=lst:pythonfile,
    language=Python
]{listings/example.py}

\lstinputlisting[%
    caption={C++ example from file},
    label=lst:cppfile,
    language=C++,
    numbers=left
]{listings/example.cc}

\begin{lstlisting}[
    caption={Python code in \LaTeX{} document},
    label=lst:pythondoc,
    language=Python]
import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(0, 1)
y = np.sin(2 * np.pi * x)

plt.plot(x, y)
plt.show()
\end{lstlisting}

\begin{lstlisting}[
    caption={C++ code in \LaTeX{} document},
    label=lst:cppdoc,
    language=C++]
#include <iostream>
using namespace std;

int main()
{
  cout << "Hello, World!" << endl;
  return 0;
}
\end{lstlisting}

\section{Equations}

Equations are typeset as normally in \LaTeX{}. It is common to consider equations part of the surrounding sentences, and include punctuation in the equations accordingly, e.g.,
\begin{equation}
    f(x) = \int_1^x \frac{1}{y}\,dy = \ln x\,.
    \label{eq:logarithm}
\end{equation}
For more advanced symbols lieke, e.g., $\mathbb{R}, \mathbb{Q}$, the \texttt{amssymb} package is preloaded, and for more advanced mathematical layout the \texttt{amsmath} behaviour is obtained through the \texttt{mathdesign} package. Confer the overleaf documentation for details.\footnote{\url{https://www.overleaf.com/learn/latex/Mathematical_expressions}}

\section{Fonts}

Bitstream Charter at 11pt with the corresponding Mathdesign math fonts have been selected as the main fonts for the thesis template. For code examples, the monospaced font should be used – for this, a scaled version of the DejaVuSansMono to match the main font is preselected. If you would like to use an accompanying sans serif font, the BeraSans has been made available. The standard \LaTeX{} font commands should be used to switch between fonts, e.g.,
\texttt{\textbackslash textit\{\}} \textit{for italics},
\texttt{\textbackslash textbf\{\}} \textbf{for bold face},
\texttt{\textbackslash texttt\{\}} \texttt{for mono spaced}, and
\texttt{\textbackslash textsf\{\}} \textsf{for sans serif}.
For generic \emph{emphasis}, \texttt{\textbackslash emph\{\}} should be applied.

\section{Cross References}
\label{sec:crossref}

For cross references, i.e., references within the document, the \texttt{\textbackslash cref\{\}} command provided byt the \texttt{cleveref} package should be used. Labels are inserted in the document in the standard \LaTeX{} manner. They are case sensitive, so, e.g., a label immediately after a section command refers to that section, while a label within, e.g., a table environment refers to the table. The \texttt{\textbackslash cref\{\}} command also generates the corresponding text. If the document is in English (class options \texttt{british} or \texttt{american}), the cross references are capitalised, whereas if it is in Norwegian (class options \texttt{norsk} or \texttt{nynorsk}), they are not. If you are writing in Norwegian, you should use \texttt{\textbackslash Cref\{\}} at the beginning of a sentence to ensure that the cross reference is correctly capitalised. For examples on usage, see \cref{sec:crossref} in \cref{chap:usage}, \cref{tab:example1}, \cref{fig:mapNTNU}, \cref{eq:logarithm}, \cref{lst:cppfile}, \cref{paper:scrutiny}, and \cref{app:additional}. \Cref{app:additional} at the beginning of a sentence.

The cross references are made into active hyperlinks in the resulting PDF document by the use of the \texttt{hyperref} package. The colour of the links is set to black for best appearance on print. This can easily be changed by the author by the use of the \texttt{\textbackslash hypersetup\{\}} command.

\section{Glossary and Acronyms}
The template comes with the ability to create a glossary and acronym list. To add entries to one of these lists, add them to the \texttt{glossary.tex} file.
All uses of the acronym and glossary functions will create a clickable link that references the corresponding entry in one of the lists. All entries in the lists will also contain page references to all places it has been used.
\subsection{Using Acronyms}
To render acronyms, you have three options:
\begin{itemize}
  \item \texttt{\textbackslash acrlong\{ \}} prints the phrase the acronym stands for, e.g. \texttt{\textbackslash acrlong\{gcd\}} displays \acrlong{gcd}.
  \item \texttt{\textbackslash acrshort\{ \}} prints the acronym, e.g. \texttt{\textbackslash acrshort\{gcd\}} displays \acrshort{gcd}.
  \item \texttt{\textbackslash acrfull\{ \}} prints both the acronym and its definition, e.g. \texttt{\textbackslash acrfull\{gcd\}} displays \acrfull{gcd}.
\end{itemize}

\subsection{Using Glossary}
\begin{itemize}
  \item \texttt{\textbackslash gls\{ \}} prints the term in lowercase, e.g. \texttt{\textbackslash gls\{maths\}} displays \gls{maths}.
  \item \texttt{\textbackslash Gls\{ \}} prints the term in with first letter in uppercase, e.g. \texttt{\textbackslash Gls\{maths\}} displays \Gls{maths}.
  \item \texttt{\textbackslash glspl\{ \}} prints the term in plural form, e.g. \texttt{\textbackslash glspl\{bibliography\}} displays \glspl{bibliography}.
  \item \texttt{\textbackslash Glspl\{ \}} prints the term in plural form capitalized, e.g. \texttt{\textbackslash Glspl\{bibliography\}} displays \Glspl{bibliography}.
\end{itemize}


\section{Bibliography}

The \gls{bibliography} is typset using the \texttt{biblatex} package with the \texttt{biber} backend. The default citation style is \texttt{numeric-comp}, and the default bibliography style is \texttt{numeric}. This produces a bibliography similar to, but not completely according to, the so-called Vancouver style. With this setup, a single \texttt{\textbackslash cite\{\}} command will give a number only~\cite{landes1951scrutiny}, and \texttt{\textbackslash textcite\{\}} will give author and number like this: \textcite{landes1951scrutiny}. If you would like to give the full reference of a paper within the thesis, e.g., in a list of included papers, use \texttt{\textbackslash fullcite\{\}} like this: \fullcite{landes1951scrutiny}.

\section{Included Papers}

If you are writing a compiled PhD thesis (and probably only then – see \cref{sec:compiledphd}), you will need to attach the papers containing the main contribution of the thesis. This can be done issuing the \texttt{paper} environment. It takes two arguments: (i) the PDF file, and (ii) a label for cross referencing. See \cref{paper:scrutiny} for an example.

\section{Appendices}

Additional material that does not fit in the main thesis but may still be relevant to share, e.g., raw data from experiments and surveys, code listings, additional plots, pre-project reports, project agreements, contracts, logs etc., can be put in appendices. Simply issue the command \texttt{\textbackslash appendix} in the main \texttt{.tex} file, and then the following chapters made by \texttt{\textbackslash chapter\{\}} become appendices. See \cref{app:additional} for an example.
